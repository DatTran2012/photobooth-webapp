<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Photobooth ‚Äî Instax Style Selection</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&family=Varela+Round&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --accent1:#FFD1DC; /* Soft Pink */
    --accent2:#FFEBCD; /* Soft Peach */
    --accent3:#E6E6FA; /* Light Lavender */
    --primary:#FF69B4; /* Hot Pink/Rose */
    --muted:#9aa3b2;
    --instax-dark: #333333; 
    --instax-light: #F0F0F0; 
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: 'Nunito', system-ui, sans-serif; background: linear-gradient(180deg,var(--bg),#ffffff 70%);
    color:#263238; -webkit-font-smoothing:antialiased;
    display:flex; align-items:flex-start; justify-content:center; padding:28px 16px;
  }

  /* Container ch·ª©a t·∫•t c·∫£ m√†n h√¨nh */
  .container{
    width:980px; max-width:100%; background:var(--panel); border-radius:14px; box-shadow:0 10px 30px rgba(20,30,50,0.08);
    padding:22px; 
    display:flex; 
    flex-direction: column;
    gap: 18px; 
  }

  /* ---------------------------------- M√ÄN H√åNH WELCOME ---------------------------------- */
  #welcomeScreen {
    width: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    min-height: 600px; /* Chi·ªÅu cao t·ªëi thi·ªÉu */
    flex-direction: column;
  }

  /* ---------------------------------- M√ÄN H√åNH CH·ª§P ---------------------------------- */
  #captureScreen {
    /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã b·∫±ng JS khi c·∫ßn */
    display: none;
    grid-template-columns: 1fr 320px; 
    gap: 18px;
    width: 100%;
  }

  /* Kh·ªëi Camera v√† Controls (Chi·∫øm c·ªôt 1 - ph·∫ßn m·ªü r·ªông) */
  #cameraAndControls { 
    grid-column: 1 / 2;
    display: flex; 
    flex-direction: column;
    align-items: center;
  }

  /* Kh·ªëi Settings Sidebar (Chi·∫øm c·ªôt 2 - ph·∫ßn c·ªë ƒë·ªãnh) */
  #settingsSidebar {
    grid-column: 2 / 3;
    display: flex;
    flex-direction: column;
    padding: 8px; 
    background: var(--bg); 
    border-radius: 10px;
  }

  /* ƒêi·ªÅu ch·ªânh Camera Wrap ƒë·ªÉ chi·∫øm 100% c·ªßa c·ªôt 1 */
  .camera-wrap{ 
    position:relative; 
    width:100%; 
    height: 600px; 
    max-width: none; 
    border-radius:14px; 
    overflow:hidden;
    box-shadow:0 6px 18px rgba(13,25,40,0.06); 
    background:linear-gradient(180deg,#111 0%, #333 100%); 
  }
  video#video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform: scaleX(-1); }
  canvas#overlay{ position:absolute; inset:0; pointer-events:none; } 
  
  /* Controls (n√∫t Start, Reset) n·∫±m d∆∞·ªõi camera, cƒÉn gi·ªØa */
  .controls{ margin-top:12px; width:100%; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  
  /* Style chung cho n√∫t - c√≥ icon */
  .btn { 
    background: linear-gradient(180deg,var(--accent1),var(--accent3)); border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    box-shadow:0 6px 18px rgba(155,107,255,0.08); font-weight:700; color:#2b2335; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
    transition: opacity 0.2s; /* Th√™m transition cho hi·ªáu ·ª©ng disable */
  }

  /* Style cho tr·∫°ng th√°i disable */
  .btn:disabled, select:disabled, input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
  }
  
  .btn.secondary{ 
    background:transparent; border:1px solid #eee; box-shadow:none; font-weight:600; color:var(--muted); 
    padding: 8px 12px; 
  }

  .option-row{ margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  select, input[type=number], input[type=text]{ 
    padding:8px 10px; border-radius:8px; border:1px solid #eee; background:#fff; outline:none; font-weight:600; 
    transition: opacity 0.2s; /* Th√™m transition cho hi·ªáu ·ª©ng disable */
  }
  
  .left { display: none; } 

  /* ---------------------------------- M√ÄN H√åNH REVIEW ---------------------------------- */
  #reviewScreen {
      width: 100%;
      display: none; 
      flex-direction: column;
  }
  .review-inner { padding:8px 14px; display:flex; flex-direction:column; }
  
  /* Thi·∫øt l·∫≠p ri√™ng cho kh·ªëi settings tr√™n Review ƒë·ªÉ kh√¥ng c√≥ padding tr√™n d∆∞·ªõi*/
  #reviewSettings { padding-top: 0; padding-bottom: 0; }
  
  .preview-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:8px; }
  
  /* ƒê√£ c·∫≠p nh·∫≠t: B·ªè aspect-ratio c·ª©ng, s·∫Ω ƒë∆∞·ª£c set b·∫±ng JS d·ª±a tr√™n t·ª∑ l·ªá film Instax (gi·ªù l√† 1:1) */
  .instax-thumb-frame {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%; 
    /* ƒê√£ b·ªè padding d∆∞·ªõi ƒë·ªÉ gi·∫£m m√¥ ph·ªèng ch√¢n tr·∫Øng Instax */
    padding: 6px 6px 6px 6px; 
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    cursor: pointer; 
  }
  .instax-thumb-frame img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 3px; 
    box-shadow: none; 
  }
  .preview-grid img { 
    height: auto; 
  }

  .final-wrap{ margin-top:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  
  /* Khung Final Preview s·∫Ω nh·∫≠n aspect-ratio ƒë·ªông t·ª´ JS */
  /* FIX: TƒÉng max-width ƒë·ªÉ ·∫£nh hi·ªÉn th·ªã ƒë·∫πp h∆°n v√† kh√¥ng b·ªã co qu√° nh·ªè */
  .final-preview{ 
    max-width:300px; 
    border-radius:8px; overflow:hidden; background:#f9f9fa; 
    display:flex; align-items:center; justify-content:center; 
    box-shadow:0 8px 30px rgba(30,40,60,0.06); 
    position: relative; 
    width: auto; 
    height: auto; 
    /* ƒê√£ b·ªè aspect-ratio m·∫∑c ƒë·ªãnh */
  }
  .final-preview img{ 
    width:100%; 
    height:100%; 
    object-fit:cover; 
  }

  .small{ font-size:13px; color:var(--muted); }
.countdown { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
    font-size:92px; color:white; font-weight:900; text-shadow:0 8px 30px rgba(0,0,0,0.6); }

  .theme-line{ display:flex; align-items:center; gap:8px; justify-content:space-between; margin-top:8px;}
  .theme-tag{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); padding:6px 10px; border-radius:999px; font-weight:700; color:#3b2b47; box-shadow:0 6px 20px rgba(255,105,180,0.06); }

  footer{ margin-top:12px; font-size:12px; color:var(--muted); text-align:center; grid-column:1/-1; }

  /* ---------------------------------- T·ªêI ∆ØU MOBILE ---------------------------------- */
  @media (max-width:900px){
    .container{ width:92%; }
    
    #welcomeScreen { min-height: 400px; }

    #captureScreen {
        grid-template-columns: 1fr; 
        gap: 0;
    }
    
    #cameraAndControls { grid-column: 1 / -1; }
    .camera-wrap{ height: 420px; }

    #settingsSidebar {
        grid-column: 1 / -1; 
        margin-top: 18px; 
        padding: 0; 
        background: transparent;
        border-radius: 0;
    }
    
    .theme-line, .option-row { padding: 0 10px; }

    /* FIX: ƒêi·ªÅu ch·ªânh max-width tr√™n tablet/m√†n h√¨nh nh·ªè ƒë·ªÉ ·∫£nh gh√©p kh√¥ng b·ªã co qu√° nhi·ªÅu */
    .final-preview{ max-width: 220px; } 
    .final-wrap{ justify-content: center; } 
  }

  @media (max-width:500px){
    body{ padding: 12px 6px; }
    .container{ padding: 10px; width: 100%; }
    
    .camera-wrap{ height: 380px; }
    
    .controls{ justify-content: center; gap: 4px; }
    
    /* ƒêi·ªÅu ch·ªânh n√∫t cho mobile */
    .btn { font-size: 13px; padding: 8px 10px; flex-grow: 1; min-width: 45%; }
    .btn#startBtn { min-width: 60%; } 
    
    .option-row{ flex-direction: column; align-items: stretch; margin-top: 8px; }
    .option-row label.small { width: 100%; text-align: left; margin-bottom: 2px; }
    
    .final-wrap{ flex-direction: column; gap: 12px; align-items: center; margin-top: 10px; width: 100%; overflow-x: hidden; }
    .final-wrap > div:first-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center; 
        padding: 0 10px;
        box-sizing: border-box;
    }
    
    .final-preview { max-width: 100%; width: 100%; height: auto; flex-shrink: 0; }
    
    .review-inner { padding: 4px; overflow-x: hidden; }
    #finalActions { padding-top: 0 !important; }
  }
</style>
</head>
<body>

<div class="container">
  
  <div id="welcomeScreen" style="display: flex;">
      <div style="text-align:center; padding: 40px 20px;">
          <h1 style="color: var(--primary); font-size: 2.2em; margin-bottom: 5px;">
              üì∏ Photobooth Instax Studio
          </h1>
          <p style="color: var(--muted); font-size: 1.1em; max-width: 500px; margin: 0 auto 30px;">
              S·∫µn s√†ng t·∫°o ·∫£nh strip 4 pose phong c√°ch Photobooth v·ªõi c√°c t√πy ch·ªçn n·ªÅn v√† layout ƒë·ªôc ƒë√°o.
          </p>
          
          <div style="display: inline-block; text-align: left; background: var(--bg); padding: 18px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;">
              <strong style="color: #3b2b47;">H∆∞·ªõng d·∫´n:</strong>
              <ul style="list-style: none; padding: 0; margin: 10px 0 0; font-size: 0.95em;">
                  <li style="margin-bottom: 5px;">‚úÖ B·∫•m **B·∫Øt ƒê·∫ßu** v√† c·∫•p quy·ªÅn Camera.</li>
                  <li style="margin-bottom: 5px;">‚úÖ ƒê·∫øm ng∆∞·ª£c **3 gi√¢y** gi·ªØa m·ªói l·∫ßn ch·ª•p (t·ªïng 4 pose).</li>
                  <li>‚úÖ ·∫¢nh ch·ª•p c·ªë ƒë·ªãnh **T·ª∑ l·ªá 1:1 (Square)**. T√πy ch·ªânh **N·ªÅn/Layout** sau khi ch·ª•p xong.</li>
              </ul>
          </div>

          <button class="btn" id="startPhotoboothBtn" style="font-size: 1.2em; padding: 12px 20px;">
              B·∫Øt ƒê·∫ßu Ch·ª•p ·∫¢nh <span style="font-size: 1.1em;">‚Üí</span>
          </button>
      </div>
  </div>

  <div id="captureScreen">
    
    <div id="cameraAndControls">
        <div class="camera-wrap" id="cameraWrap">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
            <div class="countdown" id="countdown" style="display:none"></div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">
                <span style="font-size: 1.2em; line-height: 1;">üì∏</span> Start Photobooth
            </button>
            <button class="btn secondary" id="redoBtn">
                <span style="font-size: 1.1em; line-height: 1;">üóëÔ∏è</span> Reset ·∫¢nh Ch·ª•p
            </button> 
            <button class="btn secondary" id="stopCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">üõë</span> T·∫Øt Camera
            </button> 
            <button class="btn secondary" id="switchCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">üîÑ</span> ƒê·ªïi Camera
            </button> 
            <button class="btn secondary" id="refreshBtn">
                <span style="font-size: 1.1em; line-height: 1;">‚ö°</span> Refresh Trang
            </button> 
        </div>
    </div>


    <div id="settingsSidebar">
      <div style="font-weight:700; color: #3b2b47; margin-bottom: 10px;">T√ôY CH·ªåN CH·ª§P ·∫¢NH</div>
      
      <div class="option-row" style="width:100%; justify-content:space-between; flex-wrap:nowrap; margin-top:12px;">
        <label class="small">Timer (gi·ªØa m·ªói pose):</label>
        <input id="intervalSec" type="number" value="2" min="1" style="width:70px"/>
      </div>
      
      <div class="theme-line" style="width:100%; margin-top:10px;">
        <div class="theme-tag">Photobooth - Made by Dat Tran</div>
        <div class="small">Photobooth Studio ‚Ä¢ 4 pose</div>
      </div>
    </div>
  </div>

  <div id="reviewScreen">
    <button class="btn secondary" id="backToCaptureBtn" style="margin-bottom: 12px; margin-left: 10px;">
        <span style="font-size: 1.1em; line-height: 1;">‚Üê</span> Quay l·∫°i trang Ch·ª•p ·∫¢nh
    </button>
    
    <div id="reviewSettings" class="review-inner">
      <div style="font-weight:700; color: #3b2b47; margin-bottom: 10px;">T√ôY CH·ªåN ·∫¢NH GH√âP (MERGE)</div>

      <div class="option-row" style="width:100%; margin-top:0px;">
          <label class="small">Background Strip:</label>
          <select id="backgroundSelect" style="flex:1;">
            <option value="default">M·∫∑c ƒë·ªãnh (Tr·∫Øng T·ªëi Gi·∫£n)</option>
            <option value="soft_rose_gradient">‚ù§Ô∏è Gradient H·ªìng Kem D·ªãu</option>
            <option value="romantic_red_velvet">üåπ Nhung ƒê·ªè L√£ng M·∫°n</option>
            <option value="lavender_haze_blur">‚ú® Xanh T√≠m S∆∞∆°ng M·ªù</option>
            <option value="sweetheart_pink_dots">üíñ Ch·∫•m Bi Tr√°i Tim H·ªìng</option>
            <option value="sunset_kiss_gradient">üåÖ Gradient H√¥n Chi·ªÅu T√†</option>
            <option value="champagne_toast">ü•Ç V√†ng Kem √Ånh Kim</option>
            <option value="blush_watercolor">üå∏ M√†u N∆∞·ªõc H·ªìng Ph·ªõt</option>
            <option value="mint_love_stripes">üåø S·ªçc Xanh Mint D·ªãu M√°t</option>
            <option value="starry_night_light">üåå B·∫ßu Tr·ªùi ƒê√™m L·∫•p L√°nh</option>
            <option value="coral_dream">üß° San H√¥ M∆° M√†ng</option>
            <option value="berry_smoothie">üíú H·ªìng M√¢m X√¥i T∆∞∆°i T·∫Øn</option>
            <option value="lilac_blossom_texture">üîÆ Texture V·∫£i T√≠m Lilac</option>
            <option value="peachy_glow">üçë Cam ƒê√†o R·∫°ng R·ª°</option>
            <option value="cotton_candy_swirl">üç≠ Xo√°y K·∫πo B√¥ng G√≤n Pastel</option>
            <option value="valentines_day_hearts">üíå H·ªça Ti·∫øt Tr√°i Tim L·ªÖ T√¨nh Nh√¢n</option>
            <option value="aurora_pink_blue">üåà B·∫Øc C·ª±c Quang H·ªìng Xanh</option>
            <option value="lemonade_pink">‚òÄÔ∏è Gradient V√†ng H·ªìng T∆∞∆°i</option>
            <option value="dreamy_cloud_pastel">‚òÅÔ∏è H·ªça Ti·∫øt M√¢y B·ªìng B·ªÅnh</option>
            <option value="minimal_white_texture">‚¨ú Texture Tr·∫Øng T·ªëi Gi·∫£n (C·ªï ƒëi·ªÉn)</option>
            <option value="stripes_bw">‚ñ™Ô∏è S·ªçc ƒêen Tr·∫Øng (C·ªï ƒëi·ªÉn)</option> 
            <option value="fuji_classic_clean">üü¶ Fuji Classic Clean (Footer Xanh)</option>
          </select>
      </div>
      
      <div class="option-row" style="width:100%; margin-top:10px;">
          <label class="small">Khung Overlay (cho m·ªói ·∫£nh):</label>
          <select id="overlaySelect" style="flex:1;">
            <option value="none">Kh√¥ng c√≥</option>
            <option value="heart_corners">1. G√≥c Tr√°i Tim (H·ªìng)</option>
            <option value="film_damage">2. Hi·ªáu ·ª©ng Film C≈© (Tr·∫ßy x∆∞·ªõc/B·ª•i)</option>
          </select>
      </div>
      
      <div class="option-row" style="width:100%; justify-content:flex-start; flex-wrap:nowrap; margin-top:10px;">
        <label class="small" style="white-space:nowrap; margin-left:10px;">Text Strip:</label>
        <input id="customStripText" type="text" value="INSTAX MOMENT" style="flex:1;" maxlength="30" placeholder="VD: INSTAX MOMENT"/>
      </div>
      
      <div class="option-row" style="width:100%; justify-content:flex-start; flex-wrap:nowrap; margin-top:10px;">
        <label class="small" style="white-space:nowrap; margin-left:10px;">Sticker (Footer):</label>
        <input id="customStripSticker" type="text" value="‚≠ê" style="width:80px; text-align:center;" maxlength="2" placeholder="VD: ‚ù§Ô∏è"/>
      </div>
      
      <div class="option-row" style="width:100%; margin-top:10px; margin-bottom: 10px;">
        <label class="small">Layout In ·∫¢nh:</label>
        <select id="layoutSelect" style="flex:1;">
          <option value="vertical">1. D·ªçc (Strip) - Fixed 1:1 Photo</option>
          <option value="grid">2. L∆∞·ªõi (2x2) - Fixed 1:1 Photo</option>
        </select>
      </div>

    </div>
    
    <div class="review-inner">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div>
          <strong>Preview (4 pose)</strong>
          <div class="small">Click v√†o khung ·∫£nh ƒë·ªÉ download t·ª´ng t·∫•m</div>
        </div>
        <div class="small" id="stripSizeText">Strip size: Dynamic Size</div> 
      </div>

      <div class="preview-grid" id="previewGrid" style="margin-top:8px;"></div>
      
      <div class="final-wrap">
        <div>
          <div style="font-weight:700">Final Review (·∫¢nh ƒë√£ gh√©p - Merge)</div>
          <div class="final-preview" id="finalPreview">
            <div class="small">Ch∆∞a c√≥ ·∫£nh</div>
          </div>
        </div>
        <div id="finalActions" style="display:none; flex-direction:column; gap:8px; align-items:flex-start; padding-top:20px;">
          <div class="small">·∫¢nh ƒë√£ gh√©p xong.</div>
          <button class="btn" id="downloadFinalBtn">
            <span style="font-size: 1.1em; line-height: 1;">üì•</span> Download Final
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>Made for you ‚Äî Photobooth Square ‚Ä¢ Timezone: Asia/Ho_Chi_Minh</footer>
</div>

<script>
/* ---------- Photobooth (fixed & overlay sizing) ---------- */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
const previewGrid = document.getElementById('previewGrid');
const finalPreview = document.getElementById('finalPreview'); 
const countdownEl = document.getElementById('countdown');
// const frameSelect = document.getElementById('frameSelect'); // ƒê√É B·ªé
const layoutSelect = document.getElementById('layoutSelect'); 
const backgroundSelect = document.getElementById('backgroundSelect'); 
const customStripText = document.getElementById('customStripText');
const stripSizeText = document.getElementById('stripSizeText'); 
const finalActionsEl = document.getElementById('finalActions'); 

// NEW VARIABLES FOR OVERLAY/STICKER
const overlaySelect = document.getElementById('overlaySelect'); 
const customStripSticker = document.getElementById('customStripSticker');
// END NEW VARIABLES

// NEW UI ELEMENTS FOR SCREEN SWITCHING
const welcomeScreen = document.getElementById('welcomeScreen');
const captureScreen = document.getElementById('captureScreen');
const reviewScreen = document.getElementById('reviewScreen');
const backToCaptureBtn = document.getElementById('backToCaptureBtn');

// NEW: Capture Controls & Settings elements to disable during the sequence
const startBtn = document.getElementById('startBtn');
const redoBtn = document.getElementById('redoBtn');
const stopCamBtn = document.getElementById('stopCamBtn');
const switchCamBtn = document.getElementById('switchCamBtn');
const refreshBtn = document.getElementById('refreshBtn');
const intervalSec = document.getElementById('intervalSec');
const startPhotoboothBtn = document.getElementById('startPhotoboothBtn'); // N√∫t B·∫Øt ƒê·∫ßu ·ªü m√†n h√¨nh Welcome

const controlsToDisable = [
    startBtn, redoBtn, stopCamBtn, switchCamBtn, refreshBtn, 
    // frameSelect, // ƒê√É B·ªé
    intervalSec, startPhotoboothBtn
];

let captures = [];
const timeZone = 'Asia/Ho_Chi_Minh';
let stream = null;
let currentFacingMode = 'user'; 
let finalImageDataUrl = null; 

// CONSTANTS
const INNER_BORDER = 3; 

// NEW BASE CONSTANTS for dynamic sizing
const BASE_FRAME_H = 450; // Chi·ªÅu cao chu·∫©n cho m·ªôt t·∫•m ·∫£nh
const VERT_MARGIN_X = 30; // L·ªÅ X cho strip d·ªçc
const VERT_TEXT_H = 250; // Chi·ªÅu cao khu v·ª±c ch·ªØ strip d·ªçc
const GRID_MARGIN = 40; // L·ªÅ cho l∆∞·ªõi (X, Y, kho·∫£ng c√°ch gi·ªØa 2 ·∫£nh)
const GRID_TEXT_RATIO = 0.25; // T·ª∑ l·ªá chi·ªÅu cao khu v·ª±c ch·ªØ cho l∆∞·ªõi (so v·ªõi 2*BASE_FRAME_H)
const IMAGE_AREA_TOP_MARGIN = 30; // Margin t·ª´ ƒë·ªânh t·∫•m film ƒë·∫øn ·∫£nh (gi·∫£ ƒë·ªãnh)
const IMAGE_AREA_FOOTER_H = 60; // Chi·ªÅu cao t·ªëi thi·ªÉu c·ªßa ch√¢n tr·∫Øng Instax


// devicePixelRatio helper
function getDPR(){ return window.devicePixelRatio || 1; }

/* -------------------- T·ª∂ L·ªÜ ·∫¢NH CH·ª§P (C·ªê ƒê·ªäNH 1:1) -------------------- */

// H√†m l·∫•y t·ª∑ l·ªá (W/H) c·ªßa khu v·ª±c ·∫£nh b√™n trong film (d√πng cho live preview & drawing)
function getInstaxPhotoRatio(frameStyle) {
    // Photo Area Ratios (W/H) - C·ªë ƒë·ªãnh 1:1 (Square) theo y√™u c·∫ßu b·ªè tu·ª≥ ch·ªçn
    return 1.0; 
}

// H√†m l·∫•y t·ª∑ l·ªá (W/H) c·ªßa to√†n b·ªô film Instax (·∫£nh + ch√¢n tr·∫Øng)
function getInstaxFilmRatio(frameStyle) {
    // Film Area Ratios (W/H) - D√πng t·ª∑ l·ªá 1:1 cho thumbnail (ƒë√£ b·ªè m√¥ ph·ªèng film)
    return 1.0;
}

// C·∫≠p nh·∫≠t t·ª∑ l·ªá cho t·∫•t c·∫£ thumbnails tr√™n m√†n h√¨nh review
// D√πng t·ª∑ l·ªá 1:1 (ƒë√£ b·ªè m√¥ ph·ªèng film)
function updateThumbnailAspectRatios() {
    const numericRatio = getInstaxFilmRatio('square'); 

    const thumbs = document.querySelectorAll('.instax-thumb-frame');
    thumbs.forEach(thumb => {
        // S·ª≠ d·ª•ng numericRatio / 1 cho CSS aspectRatio (fixed 1:1)
        thumb.style.aspectRatio = `${numericRatio} / 1`; 
    });
}

/* ----------------- END T·ª∂ L·ªÜ ·∫¢NH CH·ª§P LOGIC ------------------ */


/* --------------- UI SWITCHING LOGIC (GI·ªÆ NGUY√äN) --------------- */

function showWelcomeScreen() {
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    resetAll(); 
    stopCamera(); 
}

function showReviewScreen() {
    welcomeScreen.style.display = 'none';
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'flex'; 
    
    // NEW: ƒê·∫£m b·∫£o t·ª∑ l·ªá thumbnails ch√≠nh x√°c khi chuy·ªÉn m√†n h√¨nh
    updateThumbnailAspectRatios(); 

    window.scrollTo({ top: 0, behavior: 'smooth' }); 
}

function showCaptureScreen() {
    welcomeScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    // ƒê·∫∑t captureScreen th√†nh 'grid' ƒë·ªÉ √°p d·ª•ng b·ªë c·ª•c 2 c·ªôt (Camera m·ªü r·ªông + Sidebar)
    captureScreen.style.display = 'grid'; 
}

/* --------------- END UI SWITCHING LOGIC --------------- */

// start camera
async function startCamera(){
  try {
    console.log(`Y√™u c·∫ßu camera: ${currentFacingMode === 'user' ? 'Tr∆∞·ªõc' : 'Sau'}...`);
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 }, 
        height: { ideal: 720 }, 
        facingMode: currentFacingMode 
      }, 
      audio:false 
    });
    video.srcObject = stream;
    
    await new Promise(resolve => {
        if (video.readyState >= 2) { 
            resolve();
        } else {
            video.addEventListener('loadedmetadata', resolve, { once: true });
        }
    });

    await video.play();
    resizeOverlay(); 
    drawFrameLoop();
    console.log(`Camera ${currentFacingMode === 'user' ? 'Tr∆∞·ªõc' : 'Sau'} ƒë√£ b·∫≠t`);

    video.style.transform = currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';

  } catch(e) {
    console.error('startCamera error', e);
    const name = e && e.name ? e.name : 'UnknownError';
    const msg = e && e.message ? e.message : String(e);
    alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + name + ' ‚Äî ' + msg + '\n\nKi·ªÉm tra: (1) ch·∫°y tr√™n localhost/https (2) tr√¨nh duy·ªát cho ph√©p quy·ªÅn camera (3) kh√¥ng b·ªã app kh√°c chi·∫øm d·ª•ng).');
  }
}

function stopCamera(){
  try{
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      console.log('Camera ƒë√£ t·∫Øt');
    }
  } catch(e){}
}

async function switchCamera() {
    if (captures.length > 0) {
        alert('B·∫°n ch·ªâ c√≥ th·ªÉ chuy·ªÉn ƒë·ªïi camera tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu ch·ª•p. H√£y b·∫•m "Reset ·∫¢nh Ch·ª•p" n·∫øu mu·ªën ƒë·ªïi.');
        return;
    }
    if (stream) {
        stopCamera();
    }
    currentFacingMode = (currentFacingMode === 'user' ? 'environment' : 'user');
    await startCamera();
}

function resizeOverlay(){
  const dpr = getDPR();
  const vcw = video.clientWidth;
  const vch = video.clientHeight;
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  
  if (vw === 0 || vh === 0 || vcw === 0 || vch === 0) return;

  const aspect = vw / vh;
  const wrapAspect = vcw / vch;

  let newW, newH, xOffset, yOffset;

  // CƒÉn gi·ªØa video trong wrap area (object-fit: cover)
  if (aspect > wrapAspect) {
    newH = vch;
    newW = vch * aspect;
    xOffset = (vcw - newW) / 2;
    yOffset = 0;
  } else {
    newW = vcw;
    newH = vcw / aspect;
    xOffset = 0;
    yOffset = (vch - newH) / 2;
  }

  // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc canvas (theo k√≠ch th∆∞·ªõc hi·ªÉn th·ªã th·ª±c t·∫ø c·ªßa video)
  overlay.width = vcw * dpr;
  overlay.height = vch * dpr;
  overlay.style.width = vcw + 'px';
  overlay.style.height = vch + 'px';

  // C·∫≠p nh·∫≠t transformation ƒë·ªÉ v·∫Ω
  overlayCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  overlayCtx.clearRect(0, 0, vcw, vch);
  
  // Thi·∫øt l·∫≠p bi·∫øn transform cho drawing (d√πng ƒë·ªÉ v·∫Ω khung ·∫£nh v√† ng√†y gi·ªù)
  // Bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c d√πng trong drawInstaxGuide
  overlayCtx.globalTransform = {
      scaleX: newW / vw, 
      scaleY: newH / vh, 
      offsetX: xOffset,
      offsetY: yOffset,
      dpr: dpr,
      vcw: vcw, 
      vch: vch
  };
}

function drawFrameLoop(){
  // T·∫Øt/M·ªü camera kh√¥ng c·∫ßn g·ªçi drawFrameLoop n·ªØa
  if (stream) { 
    drawInstaxGuide(overlayCtx, video.clientWidth, video.clientHeight);
    drawDateTime(overlayCtx, video.clientWidth, video.clientHeight);
    requestAnimationFrame(drawFrameLoop); 
  }
}

function roundRect(ctx, x, y, w, h, r) {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
}

function drawInstaxGuide(ctx, w, h){
    // B·ªè tu·ª≥ ch·ªçn Instax Frame Ratio, c·ªë ƒë·ªãnh t·ª∑ l·ªá ·∫£nh l√† 1:1 (Square Photo Area)
    const frameStyle = 'square'; 
    const targetRatio = getInstaxPhotoRatio(frameStyle); // 1.0
    
    let innerColor = 'rgba(255, 255, 255, 0.4)'; 
    const pad = 12;
    const cornerRadius = 18;

    ctx.save();
    
    // 1. V·∫Ω khung ngo√†i (c·ªë ƒë·ªãnh)
    const x_outer = pad;
    const y_outer = pad;
    const w_outer = w - 2 * pad;
    const h_outer = h - 2 * pad;
    
    roundRect(ctx, x_outer, y_outer, w_outer, h_outer, cornerRadius);
    ctx.lineWidth = 4;
    ctx.strokeStyle = innerColor;
    ctx.stroke();

    // 2. T√≠nh to√°n v√† v·∫Ω khung ·∫¢NH B√äN TRONG (Photo Area) d·ª±a tr√™n t·ª∑ l·ªá c·ªë ƒë·ªãnh (1:1)
    // T·ª∑ l·ªá video l√† vw/vh. T·ª∑ l·ªá ·∫£nh mong mu·ªën l√† targetRatio (1.0).
    const maxPhotoW = w_outer - 2 * pad; 
    const maxPhotoH = h_outer - 2 * pad; 
    
    let finalPhotoW, finalPhotoH;
    
    // CƒÉn t·ª∑ l·ªá ·∫£nh (targetRatio) v√†o khu v·ª±c xem (maxPhotoW x maxPhotoH)
    if ((maxPhotoW / maxPhotoH) > targetRatio) {
        // Chi·ªÅu cao l√† gi·ªõi h·∫°n
        finalPhotoH = maxPhotoH;
        finalPhotoW = Math.round(finalPhotoH * targetRatio);
    } else {
        // Chi·ªÅu r·ªông l√† gi·ªõi h·∫°n
        finalPhotoW = maxPhotoW;
        finalPhotoH = Math.round(finalPhotoW / targetRatio);
    }

    const x_inner = x_outer + pad + (maxPhotoW - finalPhotoW) / 2;
    const y_inner = y_outer + pad + (maxPhotoH - finalPhotoH) / 2;

    // V·∫Ω khung n√©t ƒë·ª©t cho khu v·ª±c ·∫£nh (Photo Area)
    ctx.strokeStyle = innerColor;
    ctx.lineWidth = 2;
    ctx.setLineDash([8, 8]);
    ctx.strokeRect(x_inner, y_inner, finalPhotoW, finalPhotoH);
    
    ctx.setLineDash([]);
    ctx.restore();
}

function drawDateTime(ctx, w, h) {
  ctx.save();
  ctx.font = '600 14px Nunito, system-ui, sans-serif';
  let textColor = 'rgba(255,255,255,0.9)';
  ctx.fillStyle = textColor;
  ctx.textAlign = 'left';
  ctx.fillText(getFormattedNow(), 14, h - 18);
  ctx.restore();
}

function getFormattedNow(){
  const now = new Date();
  const fmt = new Intl.DateTimeFormat('vi-VN', { 
    timeZone: timeZone, 
    year:'numeric', 
    month:'2-digit', 
    day:'2-digit', 
    hour:'2-digit', 
    minute:'2-digit', 
    second:'2-digit' 
  });
  return fmt.format(now).replace(',', '');
}

// NEW: Functions to control capture buttons
function disableControls() {
    controlsToDisable.forEach(ctrl => {
        if (ctrl) ctrl.disabled = true;
    });
}

function enableControls() {
    controlsToDisable.forEach(ctrl => {
        if (ctrl) ctrl.disabled = false;
    });
}

// C·∫≠p nh·∫≠t: Khi thay ƒë·ªïi background/text/layout, c·∫≠p nh·∫≠t final review realtime
backgroundSelect.addEventListener('change', () => {
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal();
});
customStripText.addEventListener('input', () => {
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal();
});
// Listener for layout change - C·∫≠p nh·∫≠t final review realtime
layoutSelect.addEventListener('change', () => {
    // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t stripSizeText ·ªü ƒë√¢y n·ªØa, v√¨ mergeStrip s·∫Ω l√†m vi·ªác ƒë√≥
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal();
    else resetAll();
});
// NEW: Listener cho overlaySelect
overlaySelect.addEventListener('change', () => {
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal();
});
// NEW: Listener cho customStripSticker
customStripSticker.addEventListener('input', () => {
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal();
});

document.getElementById('downloadFinalBtn').addEventListener('click', () => {
  if (finalImageDataUrl) {
    triggerDownload(finalImageDataUrl, `photobooth_strip_${dateForFilename()}.png`);
  } else {
    alert('Kh√¥ng t√¨m th·∫•y ·∫£nh ƒë√£ gh√©p ƒë·ªÉ t·∫£i xu·ªëng. Vui l√≤ng ch·ª•p ·∫£nh tr∆∞·ªõc.');
  }
});

backToCaptureBtn.addEventListener('click', showWelcomeScreen); // Quay l·∫°i m√†n h√¨nh Welcome

function sleep(ms){
  return new Promise(r=>setTimeout(r,ms));
}

async function startPhotobooth(){
    // B·∫Øt ƒë·∫ßu: V√¥ hi·ªáu h√≥a controls
    disableControls();
    
    captures = [];
    previewGrid.innerHTML = '';
    finalPreview.innerHTML = '<div class="small">ƒêang ch·ª•p...</div>';
    finalActionsEl.style.display = 'none';

    // ƒê·∫£m b·∫£o ƒëang ·ªü m√†n h√¨nh ch·ª•p
    if (captureScreen.style.display === 'none') {
        showCaptureScreen();
    }
    
    const interval = Math.max(1, parseInt(document.getElementById('intervalSec').value||2,10));
    const stepLabels = ['FIRST', 'SECOND', 'THIRD', 'FINAL'];

    for (let i=1;i<=4;i++){
        const label = stepLabels[i - 1] + ' PHOTO';
        await doCountdown(3, label);
        const img = takeSnapshot();
        captures.push(img);
        addThumbnail(img, i);
        // Sau khi ch·ª•p ·∫£nh th·ª© 1, 2, 3 th√¨ delay th√™m interval gi√¢y
        if (i < 4 && interval > 0) {
            countdownEl.style.display = 'flex';
            countdownEl.style.flexDirection = 'row';
            countdownEl.innerHTML = `<span style="font-size: 0.35em; font-weight: 600; opacity: 0.8;">WAITING</span><span style="line-height: 1; margin-left: 10px;">${interval}s</span>`;
            await sleep(interval * 1000);
            countdownEl.textContent = '';
            countdownEl.style.display = 'none';
        }
    }
    
    // K·∫øt th√∫c: K√≠ch ho·∫°t l·∫°i controls
    enableControls();
    
    // Chuy·ªÉn sang m√†n h√¨nh review v√† t·∫°o ·∫£nh cu·ªëi
    showReviewScreen();
    mergeAndShowFinal();
}

// NEW: H√†m takeSnapshot ƒë·ªÉ ch·ª•p ·∫£nh 1:1
function takeSnapshot() {
    const videoWidth = video.videoWidth;
    const videoHeight = video.videoHeight;
    const targetRatio = getInstaxPhotoRatio('square'); // 1.0

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // T√≠nh to√°n k√≠ch th∆∞·ªõc c·∫Øt (crop)
    const videoRatio = videoWidth / videoHeight;
    let cropX = 0, cropY = 0, cropW = videoWidth, cropH = videoHeight;
    
    if (videoRatio > targetRatio) {
        // Video r·ªông h∆°n (c·∫ßn c·∫Øt ngang)
        cropW = videoHeight * targetRatio;
        cropX = (videoWidth - cropW) / 2;
    } else {
        // Video cao h∆°n (c·∫ßn c·∫Øt d·ªçc)
        cropH = videoWidth / targetRatio;
        cropY = (videoHeight - cropH) / 2;
    }

    // Canvas s·∫Ω l√† h√¨nh vu√¥ng (W=H) v·ªõi k√≠ch th∆∞·ªõc nh·ªè h∆°n c·ªßa cropW/cropH
    canvas.width = Math.min(cropW, cropH); 
    canvas.height = Math.min(cropW, cropH);
    
    // V·∫Ω ·∫£nh ƒë√£ c·∫Øt t·ª´ video v√†o canvas
    // D√πng transform ƒë·ªÉ l·∫≠t ·∫£nh n·∫øu l√† camera tr∆∞·ªõc
    ctx.save();
    if (currentFacingMode === 'user') {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
    }

    ctx.drawImage(video, 
        cropX, cropY, cropW, cropH, // Source (t·ª´ video)
        0, 0, canvas.width, canvas.height // Destination (l√™n canvas)
    );
    
    ctx.restore();

    // √Åp d·ª•ng hi·ªáu ·ª©ng film c≈© (n·∫øu c√≥) L√äN ·∫¢NH G·ªêC (tr∆∞·ªõc khi merge)
    // N·∫øu mu·ªën √°p d·ª•ng hi·ªáu ·ª©ng film ngay khi ch·ª•p th√¨ g·ªçi h√†m ·ªü ƒë√¢y
    
    // Ch·ª•p xong th√¨ flash v√† ph√°t √¢m thanh
    flashEffect();
    playShutterSound();
    
    return canvas.toDataURL('image/png');
}


function mergeAndShowFinal() {
    mergeStrip(captures).then(result => {
        showFinal(result);
    }).catch(e => {
        console.error('L·ªói khi gh√©p ·∫£nh:', e);
        finalPreview.innerHTML = '<div class="small" style="color:red">L·ªói khi gh√©p ·∫£nh. Xem console.</div>';
    });
}

function addThumbnail(imgDataUrl, index){
    const wrapper = document.createElement('div');
    wrapper.className = 'instax-thumb-frame';
    wrapper.dataset.index = index;
    wrapper.style.aspectRatio = getInstaxFilmRatio('square') + ' / 1'; 
    
    const img = document.createElement('img');
    img.src = imgDataUrl;
    img.alt = `Pose ${index}`;
    wrapper.appendChild(img);
    
    wrapper.onclick = () => {
        triggerDownload(imgDataUrl, `photobooth_pose_${index}_${dateForFilename()}.png`);
    };
    
    previewGrid.appendChild(wrapper);
}

function dateForFilename(){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('sv', { timeZone: timeZone, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
    return fmt.format(now).replace(/[-: ]/g, '').replace('T', '_');
}

function loadImg(dataUrl){
  return new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = dataUrl;
  });
}

// C·∫≠p nh·∫≠t: showFinal nh·∫≠n object { dataUrl, W, H }
function showFinal(result){
  finalPreview.innerHTML = ''; 
  finalImageDataUrl = result.dataUrl; 
  finalActionsEl.style.display = 'flex'; 

  // √Åp d·ª•ng t·ª∑ l·ªá ƒë·ªông ƒë√£ t√≠nh to√°n
  finalPreview.style.aspectRatio = `${result.W} / ${result.H}`;

  const img = document.createElement('img');
  img.src = result.dataUrl;
  finalPreview.appendChild(img);
  
  finalPreview.style.width = 'auto'; 
  finalPreview.style.height = 'auto'; 
}


function resetAll(){
  captures = []; 
  previewGrid.innerHTML = ''; 
  finalPreview.innerHTML = '<div class="small">Ch∆∞a c√≥ ·∫£nh</div>';
  finalImageDataUrl = null; 
  finalActionsEl.style.display = 'none'; 

  // ƒê√£ b·ªè aspect-ratio m·∫∑c ƒë·ªãnh kh·ªèi resetAll
  
  finalPreview.style.width = 'auto';
  finalPreview.style.height = 'auto';

  // K√≠ch ho·∫°t l·∫°i controls sau khi reset
  enableControls(); 
}

function triggerDownload(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// KH·ªûI T·∫†O
document.addEventListener('DOMContentLoaded', () => {
    if (startPhotoboothBtn) {
        startPhotoboothBtn.addEventListener('click', () => {
            showCaptureScreen();
            startCamera();
        });
    }

    // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn
    startBtn.addEventListener('click', startPhotobooth);
    redoBtn.addEventListener('click', () => {
        if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën RESET t·∫•t c·∫£ ·∫£nh ƒë√£ ch·ª•p v√† b·∫Øt ƒë·∫ßu l·∫°i?')) {
            showWelcomeScreen(); // Quay l·∫°i m√†n h√¨nh welcome ƒë·ªÉ d·ªÖ d√†ng kh·ªüi ƒë·ªông l·∫°i
        }
    });
    stopCamBtn.addEventListener('click', stopCamera);
    switchCamBtn.addEventListener('click', switchCamera);
    refreshBtn.addEventListener('click', () => {
        window.location.reload();
    });
    
    // G·∫Øn s·ª± ki·ªán resize ƒë·ªÉ ƒëi·ªÅu ch·ªânh overlay
    window.addEventListener('resize', resizeOverlay);
});

/* ---------------------------------------------------- */
/* -------------------- DRAWING LOGIC ----------------- */
/* ---------------------------------------------------- */

// Countdown helper (unchanged)
function doCountdown(sec, stepLabel){
  return new Promise(resolve => {
    countdownEl.style.display = 'flex';
    countdownEl.style.flexDirection = 'column';
    
    let timer = sec;
    
    const intervalId = setInterval(() => {
        if (timer > 0) {
            countdownEl.innerHTML = `<span style="font-size: 0.35em; font-weight: 600; margin-bottom: 5px; opacity: 0.8;">${stepLabel}</span><span style="line-height: 1;">${timer}</span>`;
            playBeep();
            timer--;
        } else {
            clearInterval(intervalId);
            countdownEl.style.flexDirection = 'row';
            countdownEl.textContent = '';
            countdownEl.style.display = 'none';
            resolve();
        }
    }, 1000); 
    
  });
}

// NEW: Simple sound/effect for capture
function flashEffect() {
    const flash = document.createElement('div');
    flash.style.cssText = 'position: absolute; inset: 0; background: white; opacity: 0; z-index: 10;';
    document.getElementById('cameraWrap').appendChild(flash);

    flash.animate([
        { opacity: 1, offset: 0 },
        { opacity: 0, offset: 0.5 },
        { opacity: 0, offset: 1 }
    ], {
        duration: 300,
        easing: 'ease-out'
    }).onfinish = () => flash.remove();
}

function playShutterSound() {
    // C√≥ th·ªÉ th√™m √¢m thanh th·ª±c t·∫ø ·ªü ƒë√¢y, v√≠ d·ª•:
    // const audio = new Audio('shutter.mp3');
    // audio.play();
    console.log('Shutter sound played (simulated)');
}

function playBeep() {
    // C√≥ th·ªÉ th√™m √¢m thanh beep th·ª±c t·∫ø ·ªü ƒë√¢y, v√≠ d·ª•:
    // const audio = new Audio('beep.mp3');
    // audio.play();
    console.log('Beep sound played (simulated)');
}


// Draw Photo on Canvas (unchanged)
function drawPhoto(ctx, img, x, y, w, h){
  const imgRatio = img.width / img.height;
  const targetRatio = w / h; // Lu√¥n l√† 1.0 v√¨ W=H=photoW/photoH

  let dw, dh, dx, dy;

  if (imgRatio > targetRatio) {
    // Chi·ªÅu cao l√† gi·ªõi h·∫°n (Crop ngang)
    dh = h;
    dw = h * imgRatio;
    dx = x + (w - dw) / 2;
    dy = y;
  } else {
    // Chi·ªÅu r·ªông l√† gi·ªõi h·∫°n (Crop d·ªçc)
    dw = w;
    dh = w / imgRatio;
    dx = x;
    dy = y + (h - dh) / 2;
  }
  
  // drawImage (crop/cover)
  ctx.drawImage(img, dx, dy, dw, dh);
}

// Draw Overlay on Photo Area (unchanged)
function drawOverlayFrame(ctx, x, y, w, h, overlayId){
    if (overlayId === 'none') return;
    
    ctx.save();
    
    // Set clip path to the photo area
    ctx.beginPath();
    ctx.rect(x, y, w, h);
    ctx.clip(); 
    
    if (overlayId === 'heart_corners') {
        const size = Math.min(w, h) / 10; // K√≠ch th∆∞·ªõc tr√°i tim
        ctx.fillStyle = '#FF69B4'; // Hot Pink

        const drawHeart = (cx, cy, s) => {
            ctx.beginPath();
            ctx.moveTo(cx, cy + s * 0.3);
            ctx.bezierCurveTo(cx + s * 0.5, cy - s * 0.8, cx + s * 1.0, cy - s * 0.4, cx, cy + s * 0.6);
            ctx.bezierCurveTo(cx - s * 1.0, cy - s * 0.4, cx - s * 0.5, cy - s * 0.8, cx, cy + s * 0.3);
            ctx.fill();
        };

        // 4 g√≥c
        drawHeart(x + size, y + size, size); // Top-Left
        ctx.save();
        ctx.scale(-1, 1);
        drawHeart(-(x + w - size), y + size, size); // Top-Right (mirror X)
        ctx.restore();
        ctx.save();
        ctx.scale(1, -1);
        drawHeart(x + size, -(y + h - size), size); // Bottom-Left (mirror Y)
        ctx.restore();
        ctx.save();
        ctx.scale(-1, -1);
        drawHeart(-(x + w - size), -(y + h - size), size); // Bottom-Right (mirror X, Y)
        ctx.restore();

    } else if (overlayId === 'film_damage') {
        // Simple film dust/scratches overlay
        ctx.fillStyle = 'rgba(0,0,0,0.1)'; 
        
        // Add dust/specks
        for (let i = 0; i < 50; i++) {
            ctx.fillRect(x + Math.random() * w, y + Math.random() * h, 1, 1);
        }
        
        // Add light scratches
        ctx.strokeStyle = 'rgba(255,255,255,0.2)'; 
        ctx.lineWidth = 0.5;
        for (let i = 0; i < 5; i++) {
            const sx = x + Math.random() * w;
            const sy = y + Math.random() * h;
            ctx.beginPath();
            ctx.moveTo(sx, sy);
            ctx.lineTo(sx + Math.random() * 50 - 25, sy + Math.random() * 50 - 25);
            ctx.stroke();
        }
    }
    
    ctx.restore(); 
}

// Draw Complex Background (unchanged)
function drawComplexBackground(ctx, W, H, backgroundId, layout, photoH, gridGap){
    ctx.save();
    
    // V√πng khu v·ª±c ch·ªØ strip (t√≠nh l·∫°i v·ªã tr√≠)
    let textStripYStart;
    if (layout === 'vertical') {
        textStripYStart = 4 * photoH; 
    } else { 
        // L∆∞·ªõi: 2*photoH + gridGap + 2*gridOuterPadding (t·ª´ mergeStrip)
        // V·ªã tr√≠ text strip b·∫Øt ƒë·∫ßu ngay d∆∞·ªõi khu v·ª±c ·∫£nh
        const gridOuterPadding = (W - (2 * (W - 2 * 30) / 2 - 30))/2; // L·∫•y l·∫°i gridOuterPadding
        const photoW = (W - 2*gridOuterPadding - gridGap) / 2;
        textStripYStart = 2 * photoH + gridGap + 2 * gridOuterPadding; // D√πng 2*gridOuterPadding ·ªü ƒë√¢y ƒë·ªÉ kh·ªõp H
    }
    const textStripH = H - textStripYStart;
    
    if (backgroundId === 'soft_rose_gradient') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#FFD1DC'); 
        grad.addColorStop(1, '#FFEBCD'); 
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'romantic_red_velvet') {
        ctx.fillStyle = '#8B0000'; // Dark Red
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'lavender_haze_blur') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#E6E6FA'); // Lavender
        grad.addColorStop(1, '#B0E0E6'); // Powder Blue
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'sweetheart_pink_dots') {
        const patternCanvas = document.createElement('canvas');
        const patternSize = 60;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        pCtx.fillStyle = '#FFFFFF';
        pCtx.fillRect(0, 0, patternSize, patternSize);
        const drawMiniHeart = (cx, cy, s) => {
            pCtx.beginPath();
            pCtx.moveTo(cx, cy + s * 0.3);
            pCtx.bezierCurveTo(cx + s * 0.5, cy - s * 0.8, cx + s * 1.0, cy - s * 0.4, cx, cy + s * 0.6);
            pCtx.bezierCurveTo(cx - s * 1.0, cy - s * 0.4, cx - s * 0.5, cy - s * 0.8, cx, cy + s * 0.3);
            pCtx.fill();
        };
        pCtx.fillStyle = '#FFB6C1'; // Light Pink
        drawMiniHeart(patternSize * 0.25, patternSize * 0.25, 4);
        pCtx.fillStyle = '#FF69B4'; // Hot Pink
        drawMiniHeart(patternSize * 0.75, patternSize * 0.75, 3);
        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'sunset_kiss_gradient') {
        const grad = ctx.createLinearGradient(0, H, W, 0);
        grad.addColorStop(0, '#FF4D4D'); // Red-Orange
        grad.addColorStop(0.5, '#FFD700'); // Gold/Yellow
        grad.addColorStop(1, '#FFC0CB'); // Pink
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'champagne_toast') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#F5DEB3'); // Wheat
        grad.addColorStop(0.5, '#FFFACD'); // Lemon Chiffon
        grad.addColorStop(1, '#FFE4E1'); // Misty Rose
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'blush_watercolor') {
        ctx.fillStyle = '#FEE5E2'; // Very Pale Pink
        ctx.fillRect(0, 0, W, H);
        const spots = [
            { x: W * 0.1, y: H * 0.2, r: W * 0.1, color: 'rgba(255,192,203,0.5)' },
            { x: W * 0.8, y: H * 0.6, r: W * 0.15, color: 'rgba(255,160,192,0.4)' },
            { x: W * 0.4, y: H * 0.9, r: W * 0.08, color: 'rgba(255,105,180,0.3)' }
        ];
        spots.forEach(spot => {
            const grad = ctx.createRadialGradient(spot.x, spot.y, 0, spot.x, spot.y, spot.r);
            grad.addColorStop(0, spot.color);
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(spot.x, spot.y, spot.r, 0, 2 * Math.PI);
            ctx.fill();
        });
    } else if (backgroundId === 'mint_love_stripes') {
        const colorA = '#F0FFF0'; // Honeydew
        const colorB = '#98FB98'; // Pale Green
        const stripeHeight = H / 20; 
        for (let i = 0; i < 20; i++) {
            ctx.fillStyle = i % 2 === 0 ? colorA : colorB;
            ctx.fillRect(0, i * stripeHeight, W, stripeHeight);
        }
        // Footer (Text Strip) v·∫´n l√† m√†u stripes
    } else if (backgroundId === 'starry_night_light') {
        ctx.fillStyle = '#191970'; // Midnight Blue
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        for (let i = 0; i < 150; i++) {
            ctx.fillRect(Math.random() * W, Math.random() * H, 1, 1);
        }
    } else if (backgroundId === 'coral_dream') {
        ctx.fillStyle = '#FF7F50'; // Coral
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'berry_smoothie') {
        const grad = ctx.createLinearGradient(W/2, 0, W/2, H);
        grad.addColorStop(0, '#DA70D6'); // Orchid
        grad.addColorStop(1, '#BA55D3'); // Medium Orchid
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'lilac_blossom_texture') {
        ctx.fillStyle = '#E6E6FA'; // Lavender
        ctx.fillRect(0, 0, W, H);
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = 100;
        noiseCanvas.height = 100;
        const nCtx = noiseCanvas.getContext('2d');
        for (let i = 0; i < 3000; i++) {
            nCtx.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.02})`; // Very subtle dark noise
            nCtx.fillRect(Math.random() * 100, Math.random() * 100, 1, 1);
        }
        const pattern = ctx.createPattern(noiseCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'peachy_glow') {
        const grad = ctx.createLinearGradient(0, H, W, 0);
        grad.addColorStop(0, '#FFDAB9'); // Peach Puff
        grad.addColorStop(1, '#FFC0CB'); // Pink
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'cotton_candy_swirl') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#ADD8E6'); // Light Blue
        grad.addColorStop(0.5, '#FFB6C1'); // Light Pink
        grad.addColorStop(1, '#F0E68C'); // Khaki
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'valentines_day_hearts') {
        ctx.fillStyle = '#FFFFFF'; 
        ctx.fillRect(0, 0, W, H);
        const patternCanvas = document.createElement('canvas');
        const patternSize = 80;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        pCtx.fillStyle = '#F0F0F0'; 
        pCtx.fillRect(0, 0, patternSize, patternSize);
        pCtx.fillStyle = '#FF69B4'; // Hot Pink
        const drawSmallHeart = (cx, cy, s) => {
            pCtx.beginPath();
            pCtx.moveTo(cx, cy + s * 0.3);
            pCtx.bezierCurveTo(cx + s * 0.5, cy - s * 0.8, cx + s * 1.0, cy - s * 0.4, cx, cy + s * 0.6);
            pCtx.bezierCurveTo(cx - s * 1.0, cy - s * 0.4, cx - s * 0.5, cy - s * 0.8, cx, cy + s * 0.3);
            pCtx.fill();
        };
        drawSmallHeart(patternSize * 0.25, patternSize * 0.25, 4);
        drawSmallHeart(patternSize * 0.75, patternSize * 0.5, 3);
        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'aurora_pink_blue') {
        const grad = ctx.createLinearGradient(0, H, W, 0);
        grad.addColorStop(0, '#00BFFF'); // Deep Sky Blue
        grad.addColorStop(0.5, '#FFFFFF');
        grad.addColorStop(1, '#FF69B4'); // Hot Pink
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'lemonade_pink') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#FFD700'); // Gold
        grad.addColorStop(0.7, '#FFC0CB'); // Pink
        grad.addColorStop(1, '#FFFFFF');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'dreamy_cloud_pastel') {
        ctx.fillStyle = '#F0F8FF'; // Alice Blue
        ctx.fillRect(0, 0, W, H);
        // Soft clouds texture
        const patternCanvas = document.createElement('canvas');
        const patternSize = 150;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        pCtx.fillStyle = '#F0F8FF';
        pCtx.fillRect(0, 0, patternSize, patternSize);
        pCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        pCtx.beginPath();
        pCtx.arc(30, 30, 20, 0, 2 * Math.PI);
        pCtx.fill();
        pCtx.beginPath();
        pCtx.arc(120, 80, 40, 0, 2 * Math.PI);
        pCtx.fill();
        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'minimal_white_texture') {
        ctx.fillStyle = '#FFFFFF'; 
        ctx.fillRect(0, 0, W, H);
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = 100;
        noiseCanvas.height = 100;
        const nCtx = noiseCanvas.getContext('2d');
        for (let i = 0; i < 5000; i++) {
            nCtx.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.01})`; 
            nCtx.fillRect(Math.random() * 100, Math.random() * 100, 1, 1);
        }
        const pattern = ctx.createPattern(noiseCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
    } else if (backgroundId === 'stripes_bw') {
        const colorA = '#FFFFFF'; 
        const colorB = '#333333';
        const stripeHeight = H / 25; 
        for (let i = 0; i < 25; i++) {
            ctx.fillStyle = i % 2 === 0 ? colorA : colorB;
            ctx.fillRect(0, i * stripeHeight, W, stripeHeight);
        }
    } else if (backgroundId === 'fuji_classic_clean') {
        // 1. ƒê·∫£m b·∫£o to√†n b·ªô n·ªÅn l√† m√†u tr·∫Øng (ho·∫∑c r·∫•t nh·∫°t)
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, W, H);
        // 2. V·∫Ω d·∫£i m√†u ·ªü khu v·ª±c Footer/Text Strip (M√†u xanh Fuji nh·∫π nh√†ng)
        const fujiFooterColor = '#B3D0FF'; // M√†u xanh nh·∫°t (Light Fuji Blue)
        ctx.fillStyle = fujiFooterColor;
        ctx.fillRect(0, textStripYStart, W, textStripH);
    }
    
    ctx.restore();
}

// H√†m l·∫•y m√†u n·ªÅn film Instax m·∫∑c ƒë·ªãnh
function getFilmColor(frameStyle, backgroundId) {
    if (backgroundId !== 'default') return '#FFFFFF'; 
    // N·∫øu l√† background m·∫∑c ƒë·ªãnh, b√¢y gi·ªù s·∫Ω d√πng m√†u tr·∫Øng v√¨ ƒë√£ b·ªè vi·ªÅn Instax
    return '#FFFFFF';
}

async function mergeStrip(images){
    const layout = layoutSelect.value;
    // ƒê√£ b·ªè frameSelect. C·ªë ƒë·ªãnh t·ª∑ l·ªá ·∫£nh ch·ª•p (photo area) l√† 1:1 (Square)
    const frameStyle = 'square'; 
    const backgroundId = backgroundSelect.value;
    const overlayId = overlaySelect.value; 
    const stickerText = customStripSticker.value; 
    
    let W, H; 
    
    // T·ª∑ l·ªá ·∫¢nh B√äN TRONG (Photo Area Ratio) c·ªë ƒë·ªãnh 1:1
    const targetRatio = 1.0; 
    
    // S·ª≠ d·ª•ng BASE_FRAME_H (450px) l√†m Chi·ªÅu cao C·ªë ƒë·ªãnh c·ªßa 1 t·∫•m ·∫£nh (PHOTO)
    const photoH = BASE_FRAME_H; // 450
    const photoW = Math.round(photoH * targetRatio); // 450 (C·ªë ƒë·ªãnh 1:1)
    
    // C√†i ƒë·∫∑t margins
    // Note: VERT_MARGIN_X = 30; VERT_TEXT_H = 250; GRID_MARGIN = 40; 
    const stripMarginX = 30; // Margin X cho strip d·ªçc (s·ª≠ d·ª•ng VERT_MARGIN_X)
    const stripTextH = 250; // Chi·ªÅu cao khu v·ª±c ch·ªØ (s·ª≠ d·ª•ng VERT_TEXT_H)
    
    const gridOuterPadding = 40; // L·ªÅ ngo√†i cho l∆∞·ªõi (s·ª≠ d·ª•ng GRID_MARGIN)
    const gridGap = 30; // Kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh (ngang/d·ªçc)
    const gridTextH = 250; 

    // 1. T√≠nh to√°n K√≠ch th∆∞·ªõc Canvas (W x H)
    let textStripYStart;

    if (layout === 'vertical') {
        // Vertical Strip (4x1) - BORDERLESS (S·ª≠ d·ª•ng c·∫•u tr√∫c c≈© ƒë·ªÉ gi·ªØ l·∫°i t·ª∑ l·ªá strip)
        W = photoW + stripMarginX * 2; // 450 + 60 = 510
        H = 4 * photoH + stripTextH; // 4*450 + 250 = 2050
        textStripYStart = 4 * photoH; 

        stripSizeText.textContent = `Strip size: ${W} x ${H} pixels (Fixed 1:1 Photo)`;
    } else { 
        // Grid (2x2) - BORDERLESS
        W = 2 * photoW + gridGap + 2 * gridOuterPadding; // 2*450 + 30 + 80 = 1010
        H = 2 * photoH + gridGap + 2 * gridOuterPadding + gridTextH; // 2*450 + 30 + 80 + 250 = 1260
        textStripYStart = 2 * photoH + gridGap + 2 * gridOuterPadding;

        stripSizeText.textContent = `Grid size: ${W} x ${H} pixels (Fixed 1:1 Photo)`;
    }

    // 2. Setup Canvas
    const canvas = document.createElement('canvas');
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingQuality = 'high';

    // 3. Draw Background
    drawComplexBackground(ctx, W, H, backgroundId, layout, photoH, gridGap); 

    // Logic ƒëi·ªÅu ch·ªânh m√†u ch·ªØ
    let instaxTextColor = '#4A4A4A'; 
    let innerBorderColor = '#4A4A4A'; 
    
    // T·∫°m th·ªùi b·ªè qua logic m√†u film m·∫∑c ƒë·ªãnh
    if (backgroundId !== 'default') {
        if (backgroundId === 'romantic_red_velvet' || backgroundId === 'starry_night_light' || backgroundId === 'berry_smoothie' || backgroundId === 'coral_dream') { 
            instaxTextColor = '#FFFFFF'; 
            innerBorderColor = '#FFFFFF'; 
        } else if (backgroundId === 'stripes_bw') { 
            instaxTextColor = '#FFFFFF'; 
            innerBorderColor = '#FFFFFF';
        } else if (backgroundId === 'fuji_classic_clean') { 
            instaxTextColor = '#333333'; 
            innerBorderColor = '#333333'; 
        }
    } else {
        // N·∫øu l√† default, n·ªÅn tr·∫Øng, ch·ªØ ƒëen
        ctx.fillStyle = getFilmColor(frameStyle, backgroundId); // GetFilmColor gi·ªù l√† White
        ctx.fillRect(0,0,W,H);
    }
    
    // 4. Draw Photos
    const imagesToProcess = await Promise.all(images.map(loadImg)); 

    for (let i=0; i < imagesToProcess.length; i++) {
        const img = imagesToProcess[i];
        
        let finalImageX, finalImageY;
        
        if (layout === 'vertical') {
            finalImageX = stripMarginX;
            finalImageY = i * photoH; 
        } else { // Grid
            const col = i % 2;
            const row = Math.floor(i / 2);
            
            finalImageX = gridOuterPadding + col * (photoW + gridGap); 
            finalImageY = gridOuterPadding + row * (photoH + gridGap); 
        }
        
        // DRAW Photo (Border-less) - C√≥ th√™m vi·ªÅn n·ªôi 3px
        ctx.fillStyle = innerBorderColor;
        ctx.fillRect(finalImageX - INNER_BORDER, finalImageY - INNER_BORDER, photoW + 2*INNER_BORDER, photoH + 2*INNER_BORDER);
        
        drawPhoto(ctx, img, finalImageX, finalImageY, photoW, photoH);
        
        // DRAW Overlay
        drawOverlayFrame(ctx, finalImageX, finalImageY, photoW, photoH, overlayId);
    }
    
    // 5. Text Strip Logic (V·∫Ω ch·ªØ v√† Sticker)
    const customText = customStripText.value.toUpperCase(); 

    ctx.save();
    ctx.textAlign = 'center';
    ctx.font = '800 50px Nunito, system-ui, sans-serif'; 
    
    // V·ªã tr√≠ ch·ªØ (cƒÉn gi·ªØa khu v·ª±c Text Strip)
    const centerX = W / 2;
    const centerY = textStripYStart + textStripH / 2;
    
    // T√≠nh k√≠ch th∆∞·ªõc ch·ªØ (ƒë·ªÉ co gi√£n n·∫øu qu√° d√†i)
    let fontSize = 50; 
    let textWidth = ctx.measureText(customText).width;
    const maxTextWidth = W * 0.9; 
    
    if (textWidth > maxTextWidth) {
        fontSize = Math.floor(fontSize * (maxTextWidth / textWidth));
        ctx.font = `800 ${fontSize}px Nunito, system-ui, sans-serif`; 
    }

    ctx.fillStyle = instaxTextColor; // M√†u ch·ªØ
    ctx.fillText(customText, centerX, centerY);
    
    // V·∫Ω sticker/date (·ªü d∆∞·ªõi/tr√™n khu v·ª±c text strip)
    const stickerValue = customStripSticker.value;
    if (stickerValue) {
        ctx.save();
        ctx.font = '400 36px Nunito, system-ui, sans-serif'; 
        ctx.fillStyle = instaxTextColor;
        ctx.textAlign = 'center';
        // V·ªã tr√≠ sticker: ·ªü tr√™n text (c√°ch 10px)
        ctx.fillText(stickerValue, centerX, centerY - fontSize / 2 - 10);
        ctx.restore();
    }
    
    ctx.restore(); 

    // 6. V·∫Ω Vi·ªÅn Ngo·∫°i C√πng
    ctx.strokeStyle = '#444444'; 
    ctx.lineWidth = 4;
    ctx.strokeRect(2, 2, W-4, H-4); 

    // 7. V·∫Ω Ng√†y Gi·ªù ·ªü d∆∞·ªõi c√πng
    ctx.save();
    ctx.font = '600 16px Nunito, system-ui, sans-serif';
    ctx.fillStyle = (backgroundId === 'default' ? 'rgba(60,70,90,0.7)' : 'rgba(255,255,255,0.7)'); 

    // ƒê·∫∑c bi·ªát cho Fuji Clean ho·∫∑c n·ªÅn ƒë·∫≠m
    if (backgroundId === 'fuji_classic_clean' || backgroundId === 'romantic_red_velvet' || backgroundId === 'starry_night_light' || backgroundId === 'berry_smoothie' || backgroundId === 'coral_dream') { 
        ctx.fillStyle = '#FFFFFF';
    } else if (backgroundId === 'minimal_white_texture' || backgroundId === 'default') {
        ctx.fillStyle = 'rgba(60,70,90,0.7)';
    }

    ctx.textAlign = 'left';
    ctx.fillText(getFormattedNow(), 16, H - 18);
    ctx.restore();

    return { dataUrl: ctx.toDataURL('image/png'), W: W, H: H };
}
</script>