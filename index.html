<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Photobooth ‚Äî Instax Style Selection</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&family=Varela+Round&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --accent1:#FFD1DC; /* Soft Pink */
    --accent2:#FFEBCD; /* Soft Peach */
    --accent3:#E6E6FA; /* Light Lavender */
    --primary:#FF69B4; /* Hot Pink/Rose */
    --muted:#9aa3b2;
    --instax-dark: #333333; 
    --instax-light: #F0F0F0; 
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: 'Nunito', system-ui, sans-serif; background: linear-gradient(180deg,var(--bg),#ffffff 70%);
    color:#263238; -webkit-font-smoothing:antialiased;
    display:flex; align-items:flex-start; justify-content:center; padding:28px 16px;
  }

  /* Container ch·ª©a t·∫•t c·∫£ m√†n h√¨nh */
  .container{
    width:980px; max-width:100%; background:var(--panel); border-radius:14px; box-shadow:0 10px 30px rgba(20,30,50,0.08);
    padding:22px; 
    display:flex; 
    flex-direction: column;
    gap: 18px; 
  }

  /* ---------------------------------- M√ÄN H√åNH WELCOME ---------------------------------- */
  #welcomeScreen {
    width: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    min-height: 600px; /* Chi·ªÅu cao t·ªëi thi·ªÉu */
    flex-direction: column;
  }

  /* ---------------------------------- M√ÄN H√åNH CH·ª§P ---------------------------------- */
  #captureScreen {
    /* M·∫∑c ƒë·ªãnh ·∫©n, s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã b·∫±ng JS khi c·∫ßn */
    display: none;
    grid-template-columns: 1fr 320px; 
    gap: 18px;
    width: 100%;
  }

  /* Kh·ªëi Camera v√† Controls (Chi·∫øm c·ªôt 1 - ph·∫ßn m·ªü r·ªông) */
  #cameraAndControls { 
    grid-column: 1 / 2;
    display: flex; 
    flex-direction: column;
    align-items: center;
  }

  /* Kh·ªëi Settings Sidebar (Chi·∫øm c·ªôt 2 - ph·∫ßn c·ªë ƒë·ªãnh) */
  #settingsSidebar {
    grid-column: 2 / 3;
    display: flex;
    flex-direction: column;
    padding: 8px; 
    background: var(--bg); 
    border-radius: 10px;
  }

  /* ƒêi·ªÅu ch·ªânh Camera Wrap ƒë·ªÉ chi·∫øm 100% c·ªßa c·ªôt 1 */
  .camera-wrap{ 
    position:relative; 
    width:100%; 
    height: 600px; 
    max-width: none; 
    border-radius:14px; 
    overflow:hidden;
    box-shadow:0 6px 18px rgba(13,25,40,0.06); 
    background:linear-gradient(180deg,#111 0%, #333 100%); 
  }
  video#video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform: scaleX(-1); }
  canvas#overlay{ position:absolute; inset:0; pointer-events:none; } 
  
  /* Controls (n√∫t Start, Reset) n·∫±m d∆∞·ªõi camera, cƒÉn gi·ªØa */
  .controls{ margin-top:12px; width:100%; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  
  /* Style chung cho n√∫t - c√≥ icon */
  .btn { 
    background: linear-gradient(180deg,var(--accent1),var(--accent3)); border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    box-shadow:0 6px 18px rgba(155,107,255,0.08); font-weight:700; color:#2b2335; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
  }
  
  .btn.secondary{ 
    background:transparent; border:1px solid #eee; box-shadow:none; font-weight:600; color:var(--muted); 
    padding: 8px 12px; 
  }

  .option-row{ margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  select, input[type=number], input[type=text]{ padding:8px 10px; border-radius:8px; border:1px solid #eee; background:#fff; outline:none; font-weight:600; }
  
  .left { display: none; } 

  /* ---------------------------------- M√ÄN H√åNH REVIEW ---------------------------------- */
  #reviewScreen {
      width: 100%;
      display: none; 
      flex-direction: column;
  }
  .review-inner { padding:8px 14px; display:flex; flex-direction:column; }
  .preview-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:8px; }
  
  .instax-thumb-frame {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%; 
    aspect-ratio: 0.7 / 1; 
    padding: 6px 6px 20px 6px; 
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    cursor: pointer; 
  }
  .instax-thumb-frame img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 3px; 
    box-shadow: none; 
  }
  .preview-grid img { 
    height: auto; 
  }

  .final-wrap{ margin-top:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  
  .final-preview{ 
    max-width:220px; 
    border-radius:8px; overflow:hidden; background:#f9f9fa; 
    display:flex; align-items:center; justify-content:center; 
    box-shadow:0 8px 30px rgba(30,40,60,0.06); 
    position: relative; 
    width: auto; 
    height: auto; 
    aspect-ratio: 600 / 2050; 
  }
  .final-preview img{ 
    width:100%; 
    height:100%; 
    object-fit:cover; 
  }

  .small{ font-size:13px; color:var(--muted); }
.countdown { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
    font-size:92px; color:white; font-weight:900; text-shadow:0 8px 30px rgba(0,0,0,0.6); }

  .theme-line{ display:flex; align-items:center; gap:8px; justify-content:space-between; margin-top:8px;}
  .theme-tag{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); padding:6px 10px; border-radius:999px; font-weight:700; color:#3b2b47; box-shadow:0 6px 20px rgba(255,105,180,0.06); }

  footer{ margin-top:12px; font-size:12px; color:var(--muted); text-align:center; grid-column:1/-1; }

  /* ---------------------------------- T·ªêI ∆ØU MOBILE ---------------------------------- */
  @media (max-width:900px){
    .container{ width:92%; }
    
    #welcomeScreen { min-height: 400px; }

    #captureScreen {
        grid-template-columns: 1fr; 
        gap: 0;
    }
    
    #cameraAndControls { grid-column: 1 / -1; }
    .camera-wrap{ height: 420px; }

    #settingsSidebar {
        grid-column: 1 / -1; 
        margin-top: 18px; 
        padding: 0; 
        background: transparent;
        border-radius: 0;
    }
    
    .theme-line, .option-row { padding: 0 10px; }

    .final-preview{ max-width: 140px; } 
    .final-wrap{ justify-content: center; } 
  }

  @media (max-width:500px){
    body{ padding: 12px 6px; }
    .container{ padding: 10px; width: 100%; }
    
    .camera-wrap{ height: 380px; }
    
    .controls{ justify-content: center; gap: 4px; }
    
    /* ƒêi·ªÅu ch·ªânh n√∫t cho mobile */
    .btn { font-size: 13px; padding: 8px 10px; flex-grow: 1; min-width: 45%; }
    .btn#startBtn { min-width: 60%; } 
    
    .option-row{ flex-direction: column; align-items: stretch; margin-top: 8px; }
    .option-row label.small { width: 100%; text-align: left; margin-bottom: 2px; }
    
    .final-wrap{ flex-direction: column; gap: 12px; align-items: center; margin-top: 10px; width: 100%; overflow-x: hidden; }
    .final-wrap > div:first-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center; 
        padding: 0 10px;
        box-sizing: border-box;
    }
    
    .final-preview { max-width: 100%; width: 100%; height: auto; flex-shrink: 0; }
    
    .review-inner { padding: 4px; overflow-x: hidden; }
    #finalActions { padding-top: 0 !important; }
  }
</style>
</head>
<body>

<div class="container">
  
  <div id="welcomeScreen" style="display: flex;">
      <div style="text-align:center; padding: 40px 20px;">
          <h1 style="color: var(--primary); font-size: 2.2em; margin-bottom: 5px;">
              üì∏ Photobooth Instax Studio
          </h1>
          <p style="color: var(--muted); font-size: 1.1em; max-width: 500px; margin: 0 auto 30px;">
              S·∫µn s√†ng t·∫°o ·∫£nh strip 4 pose phong c√°ch Instax v·ªõi c√°c t√πy ch·ªçn khung ·∫£nh v√† n·ªÅn ƒë·ªôc ƒë√°o.
          </p>
          
          <div style="display: inline-block; text-align: left; background: var(--bg); padding: 18px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;">
              <strong style="color: #3b2b47;">H∆∞·ªõng d·∫´n:</strong>
              <ul style="list-style: none; padding: 0; margin: 10px 0 0; font-size: 0.95em;">
                  <li style="margin-bottom: 5px;">‚úÖ B·∫•m **B·∫Øt ƒê·∫ßu** v√† c·∫•p quy·ªÅn Camera.</li>
                  <li style="margin-bottom: 5px;">‚úÖ ƒê·∫øm ng∆∞·ª£c **3 gi√¢y** gi·ªØa m·ªói l·∫ßn ch·ª•p (t·ªïng 4 pose).</li>
                  <li>‚úÖ T√πy ch·ªânh Khung, N·ªÅn v√† Ch·ªØ vi·∫øt ·ªü thanh b√™n ph·∫£i.</li>
              </ul>
          </div>

          <button class="btn" id="startPhotoboothBtn" style="font-size: 1.2em; padding: 12px 20px;">
              B·∫Øt ƒê·∫ßu Ch·ª•p ·∫¢nh <span style="font-size: 1.1em;">‚Üí</span>
          </button>
      </div>
  </div>

  <div id="captureScreen">
    
    <div id="cameraAndControls">
        <div class="camera-wrap" id="cameraWrap">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
            <div class="countdown" id="countdown" style="display:none"></div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">
                <span style="font-size: 1.2em; line-height: 1;">üì∏</span> Start Photobooth
            </button>
            <button class="btn secondary" id="redoBtn">
                <span style="font-size: 1.1em; line-height: 1;">üóëÔ∏è</span> Reset ·∫¢nh Ch·ª•p
            </button> 
            <button class="btn secondary" id="stopCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">üõë</span> T·∫Øt Camera
            </button> 
            <button class="btn secondary" id="switchCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">üîÑ</span> ƒê·ªïi Camera
            </button> 
            <button class="btn secondary" id="refreshBtn">
                <span style="font-size: 1.1em; line-height: 1;">‚ö°</span> Refresh Trang
            </button> 
        </div>
    </div>


    <div id="settingsSidebar">
      <div style="font-weight:700; color: #3b2b47; margin-bottom: 10px;">T√ôY CH·ªåN ·∫¢NH STRIP</div>
      
      <div class="option-row" style="width:100%; margin-top:0px;">
          <label class="small">Khung ·∫¢nh Instax:</label>
          <select id="frameSelect" style="flex:1;">
            <option value="instax_mini">1. Instax Mini Classic (Tr·∫Øng)</option>
            <option value="instax_square_black">2. Instax Square (ƒêen)</option>
            <option value="instax_wide_pastel">3. Instax Wide (Pastel Mint)</option>
          </select>
      </div>
      
      <div class="option-row" style="width:100%; margin-top:10px;">
          <label class="small">Background Instax:</label>
          <select id="backgroundSelect" style="flex:1;">
            <option value="default">M·∫∑c ƒë·ªãnh (Theo Khung)</option>
            <option value="pastel_ombre_pink_blue">1. Ombre H·ªìng - Xanh Pastel</option>
            <option value="minimal_white_texture">2. Texture Tr·∫Øng T·ªëi Gi·∫£n</option>
            <option value="light_pink_stripes">3. S·ªçc H·ªìng Nh·∫°t D·ªãu M√°t</option>
            <option value="watercolor_blush">4. M√†u N∆∞·ªõc H·ªìng Ph·ªõt</option>
            <option value="cream_daisy_pattern">5. H·ªça ti·∫øt Hoa C√∫c Kem</option>
            <option value="golden_dots">6. Ch·∫•m Bi V√†ng Kim D·ªãu</option>
            <option value="soft_tartan_lavender">7. K·∫ª S·ªçc Lavender Nh·∫°t</option>
            <option value="cloud_pattern">8. H·ªça Ti·∫øt M√¢y B·ªìng B·ªÅnh</option>
            <option value="subtle_rose_pattern">9. H·ªça Ti·∫øt Hoa H·ªìng M·ªù</option>
            <option value="peach_gradient">10. Gradient Cam ƒê√†o Nh·∫π</option>
          </select>
      </div>

      <div class="option-row" style="width:100%; justify-content:space-between; flex-wrap:nowrap; margin-top:12px;">
        <label class="small">Timer (gi·ªØa m·ªói pose):</label>
        <input id="intervalSec" type="number" value="2" min="1" style="width:70px"/>
      </div>
      
      <div class="option-row" style="width:100%; justify-content:flex-start; flex-wrap:nowrap; margin-top:5px;">
        <label class="small" style="white-space:nowrap; margin-left:10px;">Text Strip:</label>
        <input id="customStripText" type="text" value="INSTAX MOMENT" style="flex:1;" maxlength="30" placeholder="VD: INSTAX MOMENT"/>
      </div>
      
      <div class="option-row" style="width:100%; margin-top:10px;">
        <label class="small">Layout In ·∫¢nh:</label>
        <select id="layoutSelect" style="flex:1;">
          <option value="vertical">1. D·ªçc (Strip) - 600√ó2050</option>
          <option value="grid">2. L∆∞·ªõi (2x2) - 1200√ó1125</option>
        </select>
      </div>

      <div class="theme-line" style="width:100%; margin-top:10px;">
        <div class="theme-tag">Photobooth - Made by Dat Tran</div>
        <div class="small">Photobooth Studio ‚Ä¢ 4 pose</div>
      </div>
    </div>
  </div>

  <div id="reviewScreen">
    <button class="btn secondary" id="backToCaptureBtn" style="margin-bottom: 12px; margin-left: 10px;">
        <span style="font-size: 1.1em; line-height: 1;">‚Üê</span> Quay l·∫°i trang Ch·ª•p ·∫¢nh
    </button>
    
    <div class="review-inner">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div>
          <strong>Preview (4 pose)</strong>
          <div class="small">Click v√†o khung ·∫£nh ƒë·ªÉ download t·ª´ng t·∫•m</div>
        </div>
        <div class="small" id="stripSizeText">Strip size: 600√ó2050</div> 
      </div>

      <div class="preview-grid" id="previewGrid" style="margin-top:8px;"></div>
      
      <div class="final-wrap">
        <div>
          <div style="font-weight:700">Final Preview</div>
          <div class="final-preview" id="finalPreview">
            <div class="small">Ch∆∞a c√≥ ·∫£nh</div>
          </div>
        </div>
        <div id="finalActions" style="display:none; flex-direction:column; gap:8px; align-items:flex-start; padding-top:20px;">
          <div class="small">·∫¢nh ƒë√£ gh√©p xong.</div>
          <button class="btn" id="downloadFinalBtn">
            <span style="font-size: 1.1em; line-height: 1;">üì•</span> Download Final
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>Made for you ‚Äî Instax Classic ‚Ä¢ Timezone: Asia/Ho_Chi_Minh</footer>
</div>

<script>
/* ---------- Photobooth (fixed & overlay sizing) ---------- */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
const previewGrid = document.getElementById('previewGrid');
const finalPreview = document.getElementById('finalPreview'); 
const countdownEl = document.getElementById('countdown');
const frameSelect = document.getElementById('frameSelect'); 
const layoutSelect = document.getElementById('layoutSelect'); 
const backgroundSelect = document.getElementById('backgroundSelect'); 
const stripSizeText = document.getElementById('stripSizeText'); 
const finalActionsEl = document.getElementById('finalActions'); 

// NEW UI ELEMENTS FOR SCREEN SWITCHING
const welcomeScreen = document.getElementById('welcomeScreen');
const captureScreen = document.getElementById('captureScreen');
const reviewScreen = document.getElementById('reviewScreen');
const backToCaptureBtn = document.getElementById('backToCaptureBtn');

let captures = [];
const timeZone = 'Asia/Ho_Chi_Minh';
let stream = null;
let currentFacingMode = 'user'; 
let finalImageDataUrl = null; 

// CONSTANTS
const PHOTO_STRIP_H = 450;
const VERT_TEXT_H = 250; 

// devicePixelRatio helper
function getDPR(){ return window.devicePixelRatio || 1; }

/* --------------- UI SWITCHING LOGIC (ƒê√É C·∫¨P NH·∫¨T) --------------- */

function showWelcomeScreen() {
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    resetAll(); 
    stopCamera(); 
}

function showReviewScreen() {
    welcomeScreen.style.display = 'none';
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'flex'; 
    window.scrollTo({ top: 0, behavior: 'smooth' }); 
}

function showCaptureScreen() {
    welcomeScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    // ƒê·∫∑t captureScreen th√†nh 'grid' ƒë·ªÉ √°p d·ª•ng b·ªë c·ª•c 2 c·ªôt (Camera m·ªü r·ªông + Sidebar)
    captureScreen.style.display = 'grid'; 
}

/* --------------- END UI SWITCHING LOGIC --------------- */

// start camera
async function startCamera(){
  try {
    console.log(`Y√™u c·∫ßu camera: ${currentFacingMode === 'user' ? 'Tr∆∞·ªõc' : 'Sau'}...`);
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 }, 
        height: { ideal: 720 }, 
        facingMode: currentFacingMode 
      }, 
      audio:false 
    });
    video.srcObject = stream;
    
    await new Promise(resolve => {
        if (video.readyState >= 2) { 
            resolve();
        } else {
            video.addEventListener('loadedmetadata', resolve, { once: true });
        }
    });

    await video.play();
    resizeOverlay(); 
    drawFrameLoop();
    console.log(`Camera ${currentFacingMode === 'user' ? 'Tr∆∞·ªõc' : 'Sau'} ƒë√£ b·∫≠t`);

    video.style.transform = currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';

  } catch(e) {
    console.error('startCamera error', e);
    const name = e && e.name ? e.name : 'UnknownError';
    const msg = e && e.message ? e.message : String(e);
    alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + name + ' ‚Äî ' + msg + '\n\nKi·ªÉm tra: (1) ch·∫°y tr√™n localhost/https (2) tr√¨nh duy·ªát cho ph√©p quy·ªÅn camera (3) kh√¥ng b·ªã app kh√°c chi·∫øm d·ª•ng).');
  }
}

function stopCamera(){
  try{
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      console.log('Camera ƒë√£ t·∫Øt');
    }
  } catch(e){}
}

async function switchCamera() {
    if (captures.length > 0) {
        alert('B·∫°n ch·ªâ c√≥ th·ªÉ chuy·ªÉn ƒë·ªïi camera tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu ch·ª•p. H√£y b·∫•m "Reset ·∫¢nh Ch·ª•p" n·∫øu mu·ªën ƒë·ªïi.');
        return;
    }

    if (stream) {
        stopCamera(); 
    }

    currentFacingMode = (currentFacingMode === 'user' ? 'environment' : 'user');
    
    await startCamera();
}

function resizeOverlay(){
  const dpr = getDPR();
  const vcw = video.clientWidth; 
  const vch = video.clientHeight;
  const vw = video.videoWidth; 
  const vh = video.videoHeight;
  
  if (vw === 0 || vh === 0 || vcw === 0 || vch === 0) { return; }
  
  overlay.style.width = vcw + 'px';
  overlay.style.height = vch + 'px';
  overlay.width = Math.max(1, Math.round(vw * dpr));
  overlay.height = Math.max(1, Math.round(vh * dpr));
  overlayCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function drawFrameLoop(){
  requestAnimationFrame(drawFrameLoop);
  
  if (video.videoWidth > 0 && (overlay.width === 0 || overlay.width !== Math.round(video.videoWidth * getDPR()))) {
      resizeOverlay(); 
  }

  const dpr = getDPR();
  const w = overlay.width / dpr; 
  const h = overlay.height / dpr; 
  const selectedFrame = frameSelect.value;

  overlayCtx.clearRect(0,0,w,h);

  drawFrameBorder(overlayCtx, w, h, selectedFrame);

  overlayCtx.save();
  overlayCtx.font = '600 14px Nunito, system-ui, sans-serif'; 
  let textColor = 'rgba(60,70,90,0.7)';
  if (selectedFrame === 'instax_square_black') {
      textColor = 'rgba(255,255,255,0.9)';
  }
  overlayCtx.fillStyle = textColor;
  overlayCtx.textAlign = 'left';
  overlayCtx.fillText(getFormattedNow(), 14, h - 18);
  overlayCtx.restore();
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
}

function drawFrameBorder(ctx, w, h, frameStyle){
  const pad = 12; 
  let borderThickness = 4; 
  const cornerRadius = 18;
  
  let outerColor = 'rgba(255, 255, 255, 0.9)'; 
  let innerColor = 'rgba(0, 0, 0, 0.4)'; 

  if (frameStyle === 'instax_square_black') {
      outerColor = 'rgba(51, 51, 51, 0.9)'; 
      innerColor = 'rgba(255, 255, 255, 0.6)'; 
  } else if (frameStyle === 'instax_wide_pastel') {
      outerColor = 'rgba(179, 229, 252, 0.9)'; 
      innerColor = 'rgba(0, 0, 0, 0.4)';
  }
  
  ctx.save();
  ctx.beginPath();
  roundRect(ctx, pad, pad, w-2*pad, h-2*pad, cornerRadius);
  ctx.clip();
  
  let halfBorder = borderThickness / 2;
  let x = pad + halfBorder;
  let y = pad + halfBorder;
  let width = w - 2 * pad - borderThickness;
  let height = h - 2 * pad - borderThickness;

  roundRect(ctx, x, y, width, height, cornerRadius);
  ctx.lineWidth = borderThickness;
  ctx.strokeStyle = outerColor; 
  ctx.stroke();
  ctx.restore();
  
  ctx.save();
  const innerPad = pad + borderThickness + 2; 
  const innerBorder = 1;
  
  ctx.beginPath();
  roundRect(ctx, innerPad, innerPad, w-2*innerPad, h-2*innerPad, cornerRadius-4); 
  ctx.lineWidth = innerBorder;
  ctx.strokeStyle = innerColor; 
  ctx.stroke();
  ctx.restore();
}

function getFormattedNow(){
  const now = new Date();
  const fmt = new Intl.DateTimeFormat('vi-VN', {
    timeZone: timeZone,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  return fmt.format(now).replace(',', '');
}

/* --------------- Capture & flow --------------- */
// NEW: Handler cho n√∫t B·∫Øt ƒê·∫ßu ·ªü m√†n h√¨nh Welcome
document.getElementById('startPhotoboothBtn').addEventListener('click', async () => {
  showCaptureScreen(); 
  await startCamera();
});

// Handler cho n√∫t Start Photobooth sau khi camera ƒë√£ b·∫≠t
document.getElementById('startBtn').addEventListener('click', async () => {
  if (!stream) {
    // Tr∆∞·ªùng h·ª£p n√†y kh√¥ng x·∫£y ra n·∫øu ng∆∞·ªùi d√πng ƒë√£ b·∫•m startPhotoboothBtn
    // Nh∆∞ng n·∫øu ng∆∞·ªùi d√πng t·∫Øt camera th√¨ b·∫•m n√∫t n√†y s·∫Ω b·∫≠t l·∫°i
    await startCamera();
    await new Promise(r=>setTimeout(r,300));
  }
  startPhotobooth();
});

document.getElementById('redoBtn').addEventListener('click', resetAll);
document.getElementById('stopCamBtn').addEventListener('click', () => { stopCamera(); resetAll(); });
document.getElementById('switchCamBtn').addEventListener('click', switchCamera); 
frameSelect.addEventListener('change', drawFrameLoop); 

document.getElementById('refreshBtn').addEventListener('click', () => {
    window.location.reload(); 
});

// Listener for background change
backgroundSelect.addEventListener('change', () => {
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal(); 
});

layoutSelect.addEventListener('change', () => {
    const layout = layoutSelect.value;
    if (layout === 'vertical') {
        stripSizeText.textContent = 'Strip size: 600√ó2050';
    } else {
        stripSizeText.textContent = 'Grid size: 1200√ó1125';
    }
    if (captures.length > 0 && reviewScreen.style.display !== 'none') mergeAndShowFinal(); 
    else resetAll(); 
});

document.getElementById('downloadFinalBtn').addEventListener('click', () => {
  if (finalImageDataUrl) {
    triggerDownload(finalImageDataUrl, `photobooth_instax_${dateForFilename()}.png`); 
  } else {
    alert('Kh√¥ng t√¨m th·∫•y ·∫£nh ƒë√£ gh√©p ƒë·ªÉ t·∫£i xu·ªëng. Vui l√≤ng ch·ª•p ·∫£nh tr∆∞·ªõc.');
  }
});

backToCaptureBtn.addEventListener('click', showWelcomeScreen); // Quay l·∫°i m√†n h√¨nh Welcome

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function startPhotobooth(){
  captures = []; previewGrid.innerHTML = ''; finalPreview.innerHTML = '<div class="small">ƒêang ch·ª•p...</div>';
  finalActionsEl.style.display = 'none'; 
  
  // ƒê·∫£m b·∫£o ƒëang ·ªü m√†n h√¨nh ch·ª•p
  if (captureScreen.style.display === 'none') {
      showCaptureScreen(); 
  }
  
  const interval = Math.max(1, parseInt(document.getElementById('intervalSec').value||2,10));
  
  const stepLabels = ['FIRST', 'SECOND', 'THIRD', 'FINAL']; 

  for (let i=1;i<=4;i++){ 
    const label = stepLabels[i - 1] + ' PHOTO'; 
    await doCountdown(3, label); 
    const img = takeSnapshot();
    captures.push(img);
    addThumbnail(img);
    if (i < 4) await sleep(interval*1000);
  }

  countdownEl.textContent = 'DONE!';
  countdownEl.style.flexDirection = 'row'; 
  countdownEl.style.display = 'flex';
  await sleep(1000); 
  countdownEl.style.display = 'none';

  await mergeAndShowFinal();
  
  showReviewScreen();
}

async function mergeAndShowFinal(){
  if (captures.length < 1) return;
  const merged = await mergeStrip(captures);
  showFinal(merged);
}

function addThumbnail(imgDataUrl){
  const frameDiv = document.createElement('div');
  frameDiv.className = 'instax-thumb-frame';
  frameDiv.onclick = ()=> triggerDownload(imgDataUrl, `capture_${dateForFilename()}.png`); 

  const img = document.createElement('img');
  img.src = imgDataUrl;
  
  frameDiv.appendChild(img);
  previewGrid.appendChild(frameDiv);
}

function dateForFilename(){
  const now = new Date();
  const fmt = new Intl.DateTimeFormat('sv', { timeZone: timeZone, year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit' });
  return fmt.format(now).replace(/[: ]/g,'-');
}

function doCountdown(sec, stepLabel){ 
  return new Promise(async (resolve)=>{
    countdownEl.style.display = 'flex';
    countdownEl.style.flexDirection = 'column'; 
    
    for (let s=sec; s>=1; s--){
      countdownEl.innerHTML = `<span style="font-size: 0.35em; font-weight: 600; margin-bottom: 5px; opacity: 0.8;">${stepLabel}</span><span style="line-height: 1;">${s}</span>`;
      
      playBeep();
      await sleep(850);
    }
    
    countdownEl.style.flexDirection = 'row'; 
    countdownEl.textContent = ''; 
    countdownEl.style.display = 'none';

    flashEffect();
    await sleep(150);
    resolve();
  });
}

function playBeep(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value = 800;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.08);
  } catch(e){}
}

function flashEffect(){
  const el = document.createElement('div');
  el.style.position='absolute'; el.style.inset='0'; el.style.background='rgba(255,255,255,0.9)';
  el.style.zIndex = 9999; el.style.pointerEvents='none';
  document.getElementById('cameraWrap').appendChild(el);
  setTimeout(()=> el.remove(), 90);
}

function takeSnapshot(){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  const c = tmp.getContext('2d');

  c.save();
  if (currentFacingMode === 'user') {
    c.scale(-1,1);
    c.drawImage(video, -w, 0, w, h);
  } else {
    c.drawImage(video, 0, 0, w, h);
  }
  c.restore();
  
  try {
    c.drawImage(overlay, 0, 0, w, h);

  } catch(e){ console.warn('overlay draw failed', e); }

  return tmp.toDataURL('image/png');
}

function drawComplexBackground(ctx, W, H, backgroundId){
    
    ctx.fillStyle = '#FFFFFF'; 
    ctx.fillRect(0, 0, W, H);

    if (backgroundId === 'pastel_ombre_pink_blue') {
        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#FFD1DC'); 
        grad.addColorStop(0.5, '#E6E6FA'); 
        grad.addColorStop(1, '#B3E5FC'); 
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
        
    } else if (backgroundId === 'minimal_white_texture') {
        ctx.fillStyle = '#FDFDFD';
        ctx.fillRect(0, 0, W, H);
        
        const noiseCanvas = document.createElement('canvas');
        noiseCanvas.width = 100; noiseCanvas.height = 100;
        const nCtx = noiseCanvas.getContext('2d');
        for (let i = 0; i < 2000; i++) {
            nCtx.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.03})`; 
            nCtx.fillRect(Math.random() * 100, Math.random() * 100, 1, 1);
        }
        const pattern = ctx.createPattern(noiseCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'light_pink_stripes') {
        const patternCanvas = document.createElement('canvas');
        const stripeW = 100;
        patternCanvas.width = stripeW * 2;
        patternCanvas.height = 1; 
        const pCtx = patternCanvas.getContext('2d');
        
        pCtx.fillStyle = '#F5F5F5'; 
        pCtx.fillRect(0, 0, stripeW * 2, 1);
        
        pCtx.fillStyle = '#FDEEFF'; 
        pCtx.fillRect(0, 0, stripeW, 1);

        const pattern = ctx.createPattern(patternCanvas, 'repeat-y');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
        
    } else if (backgroundId === 'watercolor_blush') {
        const grad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, W/2);
        grad.addColorStop(0, '#FFF5F0'); 
        grad.addColorStop(0.7, '#FFDADA'); 
        grad.addColorStop(1, '#F0F0F0'); 
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'cream_daisy_pattern') {
        const patternCanvas = document.createElement('canvas');
        const patternSize = 80;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        
        pCtx.fillStyle = '#FFFFF0'; 
        pCtx.fillRect(0, 0, patternSize, patternSize);
        
        pCtx.fillStyle = 'rgba(255, 105, 180, 0.1)'; 
        pCtx.beginPath();
        pCtx.arc(patternSize * 0.75, patternSize * 0.25, 4, 0, Math.PI * 2);
        pCtx.fill();

        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'golden_dots') {
        ctx.fillStyle = '#FCFBF5'; 
        ctx.fillRect(0, 0, W, H);

        const patternCanvas = document.createElement('canvas');
        const patternSize = 50;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        
        pCtx.fillStyle = 'rgba(255, 215, 0, 0.15)'; 
        pCtx.beginPath();
        pCtx.arc(patternSize * 0.25, patternSize * 0.25, 3, 0, Math.PI * 2);
        pCtx.fill();
        pCtx.beginPath();
        pCtx.arc(patternSize * 0.75, patternSize * 0.75, 2, 0, Math.PI * 2);
        pCtx.fill();

        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'soft_tartan_lavender') {
        const patternCanvas = document.createElement('canvas');
        const patternSize = 100;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        
        pCtx.fillStyle = '#F5F5FA'; 
        pCtx.fillRect(0, 0, patternSize, patternSize);
        
        pCtx.fillStyle = 'rgba(255, 192, 203, 0.4)';
        pCtx.fillRect(10, 0, 5, patternSize);
        pCtx.fillRect(45, 0, 2, patternSize);
        
        pCtx.fillStyle = 'rgba(173, 216, 230, 0.4)';
        pCtx.fillRect(0, 10, patternSize, 5);
        pCtx.fillRect(0, 60, patternSize, 2);
        
        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'cloud_pattern') {
        const patternCanvas = document.createElement('canvas');
        const patternSize = 120;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');

        pCtx.fillStyle = '#E6F0FF'; 
        pCtx.fillRect(0, 0, patternSize, patternSize);

        pCtx.fillStyle = 'rgba(255, 255, 255, 0.6)'; 
        pCtx.beginPath();
        pCtx.arc(30, 40, 15, 0, Math.PI * 2);
        pCtx.arc(50, 30, 18, 0, Math.PI * 2);
        pCtx.arc(75, 40, 15, 0, Math.PI * 2);
        pCtx.fill();

        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);
        
    } else if (backgroundId === 'subtle_rose_pattern') {
        const patternCanvas = document.createElement('canvas');
        const patternSize = 70;
        patternCanvas.width = patternSize;
        patternCanvas.height = patternSize;
        const pCtx = patternCanvas.getContext('2d');
        
        pCtx.fillStyle = '#F7F7F7'; 
        pCtx.fillRect(0, 0, patternSize, patternSize);
        
        pCtx.strokeStyle = 'rgba(255, 105, 180, 0.1)'; 
        pCtx.lineWidth = 1;
        pCtx.beginPath();
        pCtx.moveTo(patternSize * 0.2, patternSize * 0.5);
        pCtx.bezierCurveTo(patternSize * 0.4, patternSize * 0.1, patternSize * 0.6, patternSize * 0.9, patternSize * 0.8, patternSize * 0.5);
        pCtx.stroke();
        
        const pattern = ctx.createPattern(patternCanvas, 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, W, H);

    } else if (backgroundId === 'peach_gradient') {
        const grad = ctx.createRadialGradient(W/2, H/2, 0, W/2, H/2, Math.max(W, H) / 2);
        grad.addColorStop(0, '#FFE0B2'); 
        grad.addColorStop(0.7, '#FFF8E1'); 
        grad.addColorStop(1, '#FFFFFF'); 
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);
    }
}

async function mergeStrip(images){
  const layout = layoutSelect.value;
  const frameStyle = frameSelect.value;
  const backgroundId = backgroundSelect.value; 
  let W, H;

  if (layout === 'vertical') {
    W = 600; 
    H = 4 * PHOTO_STRIP_H + VERT_TEXT_H; 
  } else { 
    W = 1200; 
    const gridH = 2 * PHOTO_STRIP_H; 
    const textH = Math.round(gridH / 4); 
    H = gridH + textH; 
  }
  
  const c = document.createElement('canvas');
  c.width = W; c.height = H;
  const ctx = c.getContext('2d');
  
  let backgroundColor = '#FFFFFF'; 
  let instaxTextColor = '#FF69B4'; 
  let innerBorderColor = '#444444'; 

  if (frameStyle === 'instax_square_black' && backgroundId === 'default') {
      backgroundColor = '#333333'; 
      instaxTextColor = '#FFFFFF'; 
      innerBorderColor = '#FFFFFF'; 
  } else if (frameStyle === 'instax_wide_pastel' && backgroundId === 'default') {
      backgroundColor = '#B3E5FC'; 
      instaxTextColor = '#333333'; 
      innerBorderColor = '#333333';
  }

  if (backgroundId !== 'default') {
      drawComplexBackground(ctx, W, H, backgroundId);
      instaxTextColor = '#4A4A4A'; 
      innerBorderColor = '#4A4A4A';
  } else {
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0,0,W,H);
  }


  const photoMargin = layout === 'vertical' ? 30 : 40; 
  const innerBorder = 3; 

  if (layout === 'vertical') {
    const photoW = W - 2 * photoMargin; 
    const photoH = PHOTO_STRIP_H - 2 * photoMargin; 
    
    for (let i=0;i<images.length;i++){
      const img = await loadImage(images[i]);
      const photoY = i * PHOTO_STRIP_H;
      
      ctx.fillStyle = innerBorderColor;
      ctx.fillRect(photoMargin - innerBorder, photoY + photoMargin - innerBorder, photoW + 2*innerBorder, photoH + 2*innerBorder);
      
      drawCover(ctx, img, photoMargin, photoY + photoMargin, photoW, photoH); 
    }

  } else { 
    const photoW = W / 2 - 2 * photoMargin; 
    const photoH = PHOTO_STRIP_H - 2 * photoMargin; 
    const positions = [
      { x: 0, y: 0 }, { x: W / 2, y: 0 }, 
      { x: 0, y: PHOTO_STRIP_H }, { x: W / 2, y: PHOTO_STRIP_H }
    ];

    for (let i=0;i<images.length;i++){
      const img = await loadImage(images[i]);
      const pos = positions[i];
      const photoX = pos.x + photoMargin;
      const photoY = pos.y + photoMargin;
      
      ctx.fillStyle = innerBorderColor;
      ctx.fillRect(photoX - innerBorder, photoY - innerBorder, photoW + 2*innerBorder, photoH + 2*innerBorder);

      drawCover(ctx, img, photoX, photoY, photoW, photoH);
    }
  }

  const textStripYStart = layout === 'vertical' ? 4 * PHOTO_STRIP_H : 2 * PHOTO_STRIP_H;
  const textStripH = H - textStripYStart; 
  const customText = document.getElementById('customStripText').value.toUpperCase();

  if (customText) {
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      ctx.fillStyle = instaxTextColor; 
      
      const defaultFont = 'Varela Round'; 
      const fontSize = layout === 'vertical' ? '32px' : '64px'; 
      const fontWeight = '600'; 
      
      ctx.font = `${fontWeight} ${fontSize} '${defaultFont}', system-ui, sans-serif`;

      const centerX = W / 2;
      const centerY = textStripYStart + textStripH / 2; 
      
      const lines = customText.length > 15 && customText.includes('&') 
          ? customText.split(/\s*&\s*/) 
          : [customText];
      
      if (lines.length > 1) {
          const lineHeight = layout === 'vertical' ? 50 : 80; 
          let textY = centerY - (lineHeight / 2); 
          
          for (let j = 0; j < lines.length; j++) {
              ctx.fillText(lines[j].trim(), centerX, textY + j * lineHeight);
          }
      } else {
          ctx.fillText(customText, centerX, centerY);
      }
      
      ctx.restore();
  }

  ctx.strokeStyle = '#444444'; 
  ctx.lineWidth = 4;
  ctx.strokeRect(2, 2, W-4, H-4);

  ctx.save();
  ctx.font = '600 16px Nunito, system-ui, sans-serif';
  
  ctx.fillStyle = (backgroundId === 'default' && frameStyle === 'instax_square_black' 
                   ? 'rgba(255,255,255,0.7)' 
                   : 'rgba(60,70,90,0.7)'); 
  
  ctx.textAlign = 'left';
  ctx.fillText(getFormattedNow(), 16, H - 18); 
  ctx.restore();

  return c.toDataURL('image/png');
}

function drawCover(ctx, img, x, y, w, h){
  const iw = img.width, ih = img.height;
  const r = Math.max(w/iw, h/ih);
  const nw = iw * r, nh = ih * r;
  const cx = (nw - w)/2, cy = 0; 
  ctx.drawImage(img, -cx + x, -cy + y, nw, nh);
}

function loadImage(dataUrl){
  return new Promise((res, rej)=>{
    const i = new Image();
    i.onload = ()=> res(i);
    i.onerror = rej;
    i.src = dataUrl;
  });
}

function showFinal(dataUrl){
  finalPreview.innerHTML = ''; 
  finalImageDataUrl = dataUrl; 
  finalActionsEl.style.display = 'flex'; 

  const layout = layoutSelect.value;
  const aspectRatioString = layout === 'vertical' ? '600 / 2050' : '1200 / 1125'; 

  finalPreview.style.aspectRatio = aspectRatioString;

  const img = document.createElement('img');
  img.src = dataUrl;
  finalPreview.appendChild(img);
  
  finalPreview.style.width = 'auto'; 
  finalPreview.style.height = 'auto'; 
}


function resetAll(){
  captures = []; 
  previewGrid.innerHTML = ''; 
  finalPreview.innerHTML = '<div class="small">Ch∆∞a c√≥ ·∫£nh</div>';
  finalImageDataUrl = null; 
  finalActionsEl.style.display = 'none'; 

  finalPreview.style.aspectRatio = '600 / 2050'; 
  
  finalPreview.style.width = 'auto';
  finalPreview.style.height = 'auto';
}

function triggerDownload(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// KH·ªûI T·∫†O: B·∫Øt ƒë·∫ßu b·∫±ng m√†n h√¨nh Welcome v√† KH√îNG b·∫≠t camera ngay
window.addEventListener('load', async () => {
  resetAll(); 
  showWelcomeScreen(); 
});

window.addEventListener('resize', () => {
    resizeOverlay();
    if (finalImageDataUrl && reviewScreen.style.display !== 'none') showFinal(finalImageDataUrl);
});
</script>
  


</body>
</html>