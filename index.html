<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Photobooth â€” Instax Style Selection</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&family=Varela+Round&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --accent1:#FFD1DC; /* Soft Pink */
    --accent2:#FFEBCD; /* Soft Peach */
    --accent3:#E6E6FA; /* Light Lavender */
    --primary:#FF69B4; /* Hot Pink/Rose */
    --muted:#9aa3b2;
    --instax-dark: #333333; 
    --instax-light: #F0F0F0; 
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: 'Nunito', system-ui, sans-serif; background: linear-gradient(180deg,var(--bg),#ffffff 70%);
    color:#263238; -webkit-font-smoothing:antialiased;
    display:flex; align-items:flex-start; justify-content:center; padding:28px 16px;
  }

  /* Container chá»©a táº¥t cáº£ mÃ n hÃ¬nh */
  .container{
    width:980px; max-width:100%; background:var(--panel); border-radius:14px; box-shadow:0 10px 30px rgba(20,30,50,0.08);
    padding:22px; 
    display:flex; 
    flex-direction: column;
    gap: 18px; 
  }

  /* ---------------------------------- MÃ€N HÃŒNH WELCOME ---------------------------------- */
  #welcomeScreen {
    width: 100%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    min-height: 600px; /* Chiá»u cao tá»‘i thiá»ƒu */
    flex-direction: column;
  }

  /* ---------------------------------- MÃ€N HÃŒNH CHá»¤P ---------------------------------- */
  #captureScreen {
    /* Máº·c Ä‘á»‹nh áº©n, sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ báº±ng JS khi cáº§n */
    display: none;
    grid-template-columns: 1fr 320px; 
    gap: 18px;
    width: 100%;
  }

  /* Khá»‘i Camera vÃ  Controls (Chiáº¿m cá»™t 1 - pháº§n má»Ÿ rá»™ng) */
  #cameraAndControls { 
    grid-column: 1 / 2;
    display: flex; 
    flex-direction: column;
    align-items: center;
  }

  /* Khá»‘i Settings Sidebar (Chiáº¿m cá»™t 2 - pháº§n cá»‘ Ä‘á»‹nh) */
  #settingsSidebar {
    grid-column: 2 / 3;
    display: flex;
    flex-direction: column;
    padding: 8px; 
    background: var(--bg); 
    border-radius: 10px;
  }

  /* Äiá»u chá»‰nh Camera Wrap Ä‘á»ƒ chiáº¿m 100% cá»§a cá»™t 1 */
  .camera-wrap{ 
    position:relative; 
    width:100%; 
    height: 600px; 
    max-width: none; 
    border-radius:14px; 
    overflow:hidden;
    box-shadow:0 6px 18px rgba(13,25,40,0.06); 
    background:linear-gradient(180deg,#111 0%, #333 100%); 
  }
  video#video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform: scaleX(-1); }
  canvas#overlay{ position:absolute; inset:0; pointer-events:none; } 
  
  /* Controls (nÃºt Start, Reset) náº±m dÆ°á»›i camera, cÄƒn giá»¯a */
  .controls{ margin-top:12px; width:100%; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
  
  /* Style chung cho nÃºt - cÃ³ icon */
  .btn { 
    background: linear-gradient(180deg,var(--accent1),var(--accent3)); border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    box-shadow:0 6px 18px rgba(155,107,255,0.08); font-weight:700; color:#2b2335; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 6px; 
    transition: opacity 0.2s; /* ThÃªm transition cho hiá»‡u á»©ng disable */
  }

  /* Style cho tráº¡ng thÃ¡i disable */
  .btn:disabled, select:disabled, input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
  }
  
  .btn.secondary{ 
    background:transparent; border:1px solid #eee; box-shadow:none; font-weight:600; color:var(--muted); 
    padding: 8px 12px; 
  }

  .option-row{ margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
  select, input[type=number], input[type=text]{ 
    padding:8px 10px; border-radius:8px; border:1px solid #eee; background:#fff; outline:none; font-weight:600; 
    transition: opacity 0.2s; /* ThÃªm transition cho hiá»‡u á»©ng disable */
  }
  
  .left { display: none; } 

  /* ---------------------------------- MÃ€N HÃŒNH REVIEW ---------------------------------- */
  #reviewScreen {
      width: 100%;
      display: none; 
      flex-direction: column;
  }
  
  /* Wrapper cho 2 cá»™t trÃªn Review Screen */
  #reviewMainContent {
      display: grid;
      grid-template-columns: 1fr 1.2fr; /* TÃ¹y chá»n (trÃ¡i) 1fr, Preview (pháº£i) 1.2fr */
      gap: 18px;
      padding: 0 10px; /* ThÃªm padding ngang cho desktop */
      align-items: flex-start;
  }
  
  .review-inner { 
      /* Bá» padding cÅ©, sáº½ set láº¡i padding cá»¥ thá»ƒ cho tá»«ng block */
      display:flex; 
      flex-direction:column; 
      background: var(--bg); /* ThÃªm background cho block */
      border-radius: 10px;
      padding: 14px;
      height: 100%; /* GiÃºp 2 cá»™t cÃ¢n báº±ng chiá»u cao trÃªn desktop */
  }
  
  /* ÄÃ£ tá»‘i Æ°u hÃ³a láº¡i Ä‘á»ƒ Final Review á»Ÿ trÃªn, 4 áº£nh á»Ÿ dÆ°á»›i */
  .preview-grid{ 
      display:grid; 
      grid-template-columns:repeat(2,1fr); 
      gap:10px; 
      margin-top:8px; 
  }
  
  /* ÄÃ£ cáº­p nháº­t: Bá» aspect-ratio cá»©ng, sáº½ Ä‘Æ°á»£c set báº±ng JS dá»±a trÃªn tá»· lá»‡ film Instax (giá» lÃ  1:1) */
  .instax-thumb-frame {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%; 
    /* ÄÃ£ bá» padding dÆ°á»›i Ä‘á»ƒ giáº£m mÃ´ phá»ng chÃ¢n tráº¯ng Instax */
    padding: 6px 6px 6px 6px; 
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    cursor: pointer; 
    /* [NEW] Khung viá»n 1 line cho thumbnail */
    border: 1px solid #AAAAAA; 
  }
  .instax-thumb-frame img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 3px; 
    box-shadow: none; 
  }
  .preview-grid img { 
    height: auto; 
  }

  .final-wrap{ margin-top:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  
  /* Khung Final Preview sáº½ nháº­n aspect-ratio Ä‘á»™ng tá»« JS */
  /* FIX: TÄƒng max-width Ä‘á»ƒ áº£nh hiá»ƒn thá»‹ Ä‘áº¹p hÆ¡n vÃ  khÃ´ng bá»‹ co quÃ¡ nhá» */
  .final-preview{ 
    max-width:300px; 
    border-radius:8px; overflow:hidden; background:#f9f9fa; 
    display:flex; align-items:center; justify-content:center; 
    box-shadow:0 8px 30px rgba(30,40,60,0.06); 
    position: relative; 
    width: auto; 
    height: auto; 
    /* ÄÃ£ bá» aspect-ratio máº·c Ä‘á»‹nh */
  }
  .final-preview img{ 
    width:100%; 
    height:100%; 
    object-fit:cover; 
  }

  .small{ font-size:13px; color:var(--muted); }
.countdown { 
    position:absolute; 
    inset:0; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    pointer-events:none;
    font-size:92px; 
    color:white; 
    font-weight:900; 
    text-shadow:0 8px 30px rgba(0,0,0,0.6); 
    /* NEW: Cho phÃ©p multi-line text */
    flex-direction: column; 
    text-align: center;
    line-height: 1.2;
}

  .theme-line{ display:flex; align-items:center; gap:8px; justify-content:space-between; margin-top:8px;}
  .theme-tag{ background:linear-gradient(90deg,var(--accent2),var(--accent1)); padding:6px 10px; border-radius:999px; font-weight:700; color:#3b2b47; box-shadow:0 6px 20px rgba(255,105,180,0.06); }

  footer{ margin-top:12px; font-size:12px; color:var(--muted); text-align:center; grid-column:1/-1; }

  /* ---------------------------------- Tá»I Æ¯U MOBILE ---------------------------------- */
  @media (max-width:900px){
    .container{ width:92%; }
    
    #welcomeScreen { min-height: 400px; }

    #captureScreen {
        grid-template-columns: 1fr; 
        gap: 0;
    }
    
    #cameraAndControls { grid-column: 1 / -1; }
    .camera-wrap{ height: 420px; }

    #settingsSidebar {
        grid-column: 1 / -1; 
        margin-top: 18px; 
        padding: 0; 
        background: transparent;
        border-radius: 0;
    }
    
    .theme-line, .option-row { padding: 0 10px; }

    /* FIX: Äiá»u chá»‰nh max-width trÃªn tablet/mÃ n hÃ¬nh nhá» Ä‘á»ƒ áº£nh ghÃ©p khÃ´ng bá»‹ co quÃ¡ nhiá»u */
    .final-preview{ max-width: 220px; } 
    .final-wrap{ justify-content: center; } 
    
    /* New Mobile Adjustment for Review Screen */
    #reviewMainContent {
        grid-template-columns: 1fr; /* Trá»Ÿ vá» 1 cá»™t trÃªn mobile */
        gap: 10px; /* Giáº£m gap */
        padding: 0;
    }

    /* Loáº¡i bá» background, giáº£m padding cho mobile Ä‘á»ƒ gá»n gÃ ng hÆ¡n */
    .review-inner { 
        background: transparent;
        border-radius: 0;
        padding: 4px 10px; /* Giáº£m padding cho mobile */
        height: auto; /* Bá» giá»›i háº¡n chiá»u cao */
    }
  }

  @media (max-width:500px){
    body{ padding: 12px 6px; }
    .container{ padding: 10px; width: 100%; }
    
    .camera-wrap{ height: 380px; }
    
    .controls{ justify-content: center; gap: 4px; }
    
    /* Äiá»u chá»‰nh nÃºt cho mobile */
    .btn { font-size: 13px; padding: 8px 10px; flex-grow: 1; min-width: 45%; }
    .btn#startBtn { min-width: 60%; } 
    
    .option-row{ flex-direction: column; align-items: stretch; margin-top: 8px; }
    .option-row label.small { width: 100%; text-align: left; margin-bottom: 2px; }
    
    .final-wrap{ flex-direction: column; gap: 12px; align-items: center; margin-top: 10px; width: 100%; overflow-x: hidden; }
    .final-wrap > div:first-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center; 
        padding: 0 10px;
        box-sizing: border-box;
    }
    
    .final-preview { max-width: 100%; width: 100%; height: auto; flex-shrink: 0; }
    
    /* ÄÃ£ chuyá»ƒn .review-inner mobile setting lÃªn @media (max-width:900px) */
    #finalActions { padding-top: 0 !important; }
  }
</style>
</head>
<body>

<div class="container">
  
  <div id="welcomeScreen" style="display: flex;">
      <div style="text-align:center; padding: 40px 20px;">
          <h1 style="color: var(--primary); font-size: 2.2em; margin-bottom: 5px;">
              ğŸ“¸ Photobooth Instax Studio
          </h1>
          <p style="color: var(--muted); font-size: 1.1em; max-width: 500px; margin: 0 auto 30px;">
              Sáºµn sÃ ng táº¡o áº£nh strip 4 pose phong cÃ¡ch Photobooth vá»›i cÃ¡c tÃ¹y chá»n ná»n vÃ  layout Ä‘á»™c Ä‘Ã¡o.
          </p>
          
          <div style="display: inline-block; text-align: left; background: var(--bg); padding: 18px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;">
              <strong style="color: #3b2b47;">HÆ°á»›ng dáº«n:</strong>
              <ul style="list-style: none; padding: 0; margin: 10px 0 0; font-size: 0.95em;">
                  <li style="margin-bottom: 5px;">âœ… Báº¥m **Báº¯t Äáº§u** vÃ  cáº¥p quyá»n Camera.</li>
                  <li style="margin-bottom: 5px;">âœ… Äáº¿m ngÆ°á»£c **3 giÃ¢y** trÆ°á»›c *má»—i* pose.</li>
                  <li style="margin-bottom: 5px;">âœ… Thá»i gian **TÃ¹y chá»n** lÃ  khoáº£ng **nghá»‰ chuáº©n bá»‹** giá»¯a cÃ¡c pose.</li>
                  <li>âœ… áº¢nh chá»¥p cá»‘ Ä‘á»‹nh **Tá»· lá»‡ 1:1 (Square)**. TÃ¹y chá»‰nh **Ná»n/Layout** sau khi chá»¥p xong.</li>
              </ul>
          </div>

          <button class="btn" id="startPhotoboothBtn" style="font-size: 1.2em; padding: 12px 20px;">
              Báº¯t Äáº§u Chá»¥p áº¢nh <span style="font-size: 1.1em;">â†’</span>
          </button>
      </div>
  </div>

  <div id="captureScreen">
    
    <div id="cameraAndControls">
        <div class="camera-wrap" id="cameraWrap">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
            <div class="countdown" id="countdown" style="display:none"></div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">
                <span style="font-size: 1.2em; line-height: 1;">ğŸ“¸</span> Start Photobooth
            </button>
            <button class="btn secondary" id="redoBtn">
                <span style="font-size: 1.1em; line-height: 1;">ğŸ—‘ï¸</span> Reset áº¢nh Chá»¥p
            </button> 
            <button class="btn secondary" id="stopCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">ğŸ›‘</span> Táº¯t Camera
            </button> 
            <button class="btn secondary" id="switchCamBtn">
                <span style="font-size: 1.1em; line-height: 1;">ğŸ”„</span> Äá»•i Camera
            </button> 
            <button class="btn secondary" id="refreshBtn">
                <span style="font-size: 1.1em; line-height: 1;">âš¡</span> Refresh Trang
            </button> 
        </div>
    </div>


    <div id="settingsSidebar">
      <div style="font-weight:700; color: #3b2b47; margin-bottom: 10px;">TÃ™Y CHá»ŒN CHá»¤P áº¢NH</div>
      
      <div class="option-row" style="width:100%; justify-content:space-between; flex-wrap:nowrap; margin-top:12px;">
        <label class="small">Khoáº£ng Nghá»‰ (giá»¯a má»—i pose):</label>
        <input id="intervalSec" type="number" value="2" min="1" max="10" style="width:70px"/>
      </div>
      
      <div class="option-row" style="width:100%; justify-content:space-between; flex-wrap:nowrap; margin-top:12px;">
          <label class="small">LÃ m Má»‹n Da (Beauty):</label>
          <select id="beautyLevel" style="width:120px;">
              <option value="0">0. Táº¯t</option>
              <option value="1">1. Ráº¥t Nháº¹</option>
              <option value="2">2. Nháº¹</option>
              <option value="3" selected>3. Vá»«a (Äá» Xuáº¥t)</option>
              <option value="4">4. Trung BÃ¬nh</option>
              <option value="5">5. Máº¡nh</option>
              <option value="6">6. Ráº¥t Máº¡nh</option>
          </select>
      </div>
      <div class="theme-line" style="width:100%; margin-top:10px;">
        <div class="theme-tag">Photobooth - Made by Dat Tran</div>
        <div class="small">Photobooth Studio â€¢ 4 pose</div>
      </div>
    </div>
  </div>

  <div id="reviewScreen">
    <button class="btn secondary" id="backToCaptureBtn" style="margin-bottom: 12px; margin-left: 10px;">
        <span style="font-size: 1.1em; line-height: 1;">â†</span> Quay láº¡i trang Chá»¥p áº¢nh
    </button>
    
    <div id="reviewMainContent">
      <div id="reviewSettings" class="review-inner">
        <div style="font-weight:700; color: #3b2b47; margin-bottom: 10px;">TÃ™Y CHá»ŒN áº¢NH GHÃ‰P (MERGE)</div>

        <div class="option-row" style="width:100%; margin-top:0px;">
            <label class="small">Background Strip:</label>
            <select id="backgroundSelect" style="flex:1;">
              <option value="default">Máº·c Ä‘á»‹nh (Tráº¯ng Tá»‘i Giáº£n)</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ Táº¾T NGUYÃŠN ÄÃN 2026 â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="tet_red_gold_silk">ğŸ§§ Váº£i Lá»¥a Äá» VÃ ng (Cá»• Ä‘iá»ƒn)</option>
              <option value="tet_cherry_blossom">ğŸŒ¸ Hoa Mai/ÄÃ o Rá»±c Rá»¡</option>
              <option value="tet_banh_chung_green">ğŸ’š LÃ¡ Chuá»‘i GÃ³i BÃ¡nh</option>
              <option value="tet_firecracker_pattern">ğŸ§¨ Há»a Tiáº¿t PhÃ¡o BÃ´ng</option>
              <option value="tet_lucky_money">ğŸ’° Tiá»n LÃ¬ XÃ¬ & Äá»“ng Xu</option>
              <option value="tet_golden_dragon">ğŸ‰ Rá»“ng VÃ ng Thá»‹nh VÆ°á»£ng</option>
              <option value="tet_bamboo_stripes">ğŸ‹ Sá»c Tre Xanh Tá»‘i Giáº£n</option>
              <option value="tet_lantern_glow">ğŸ® Ãnh ÄÃ¨n Lá»“ng áº¤m Ãp</option>
              <option value="tet_calligraphy_paper">ğŸ“œ Giáº¥y ThÆ° PhÃ¡p (Äá» Ä‘áº­m)</option>
              <option value="tet_minimal_auspice">ğŸŒŸ Tá»‘i Giáº£n May Máº¯n</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ GIÃNG SINH â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="xmas_red_white_stripes">ğŸ„ Sá»c Káº¹o BÃ´ng (Äá» Tráº¯ng)</option>
              <option value="xmas_pine_forest_green">ğŸŒ² Rá»«ng ThÃ´ng Xanh Tháº³m</option>
              <option value="xmas_snowy_bokeh">â„ï¸ Bokeh Tuyáº¿t Láº¥p LÃ¡nh</option>
              <option value="xmas_gold_glitter">âœ¨ Láº¥p LÃ¡nh VÃ ng (Glitter)</option>
              <option value="xmas_cozy_knit">ğŸ§¶ Há»a Tiáº¿t Len Äan (Äá»/Kem)</option>
              <option value="xmas_gingerbread">ğŸª BÃ¡nh Gá»«ng MÃ u NÃ¢u áº¤m</option>
              <option value="xmas_santa_suit">ğŸ… Nhung Äá» & Viá»n Tráº¯ng</option>
              <option value="xmas_holly_berries">ğŸŒ¿ LÃ¡ ThÆ°á»ng XuÃ¢n & TrÃ¡i Äá»</option>
              <option value="xmas_minimal_white">ğŸ¤ Tuyáº¿t RÆ¡i Tráº¯ng Tá»‘i Giáº£n</option>
              <option value="xmas_twinkle_lights">ğŸ’¡ Ãnh ÄÃ¨n Nháº¥p NhÃ¡y</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ TÃŒNH YÃŠU â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="love_hot_pink_blur">ğŸ’• Há»“ng TÃ¬nh YÃªu (Má» áº£o)</option>
              <option value="love_watercolor_hearts">ğŸ’– TrÃ¡i Tim MÃ u NÆ°á»›c (Äá»/Há»“ng)</option>
              <option value="love_rose_petals">ğŸŒ¹ CÃ¡nh Hoa Há»“ng RÆ¡i</option>
              <option value="love_scribble_lines">ğŸ’Œ Váº½ Nguá»‡ch Ngoáº¡c (Äá»/Äen)</option>
              <option value="love_velvet_magenta">ğŸ’œ Nhung TÃ­m Äáº­m Quyáº¿n RÅ©</option>
              <option value="love_couple_galaxy">ğŸŒŒ Dáº£i NgÃ¢n HÃ  LÃ£ng Máº¡n</option>
              <option value="love_checkerboard_pink">ğŸ€ Káº» Caro Há»“ng Tráº¯ng</option>
              <option value="love_soft_peach_glow">ğŸ§¡ Cam ÄÃ o Tá»a SÃ¡ng</option>
              <option value="love_minimal_line">ã€°ï¸ Viá»n Line Art Tá»‘i Giáº£n</option>
              <option value="love_polaroid_tape">ğŸ§» Dáº£i BÄƒng DÃ­nh Vintage</option>
            </select>
        </div>
        
        <div class="option-row" style="width:100%; margin-top:10px;">
            <label class="small">Khung Overlay (cho má»—i áº£nh):</label>
            <select id="overlaySelect" style="flex:1;">
              <option value="none">KhÃ´ng cÃ³ (Clean)</option>
              <option value="heart_corners">1. GÃ³c TrÃ¡i Tim (Há»“ng)</option>
              <option value="film_damage">2. Bá»¥i & Váº¿t XÆ°á»›c (Cá»• Ä‘iá»ƒn)</option>
              <option disabled>â”€â”€â”€â”€â”€â”€ NHIá»„U & Cá»” ÄIá»‚N â”€â”€â”€â”€â”€â”€</option>
              <option value="film_grain_light">3. Háº¡t Nhiá»…u Film (Nháº¹)</option>
              <option value="film_grain_heavy">4. Háº¡t Nhiá»…u Film (Náº·ng)</option>
              <option value="vintage_sepia_light">5. MÃ u NÃ¢u Äá» (Sepia Nháº¹)</option>
              <option value="faded_matte">6. Hiá»‡u á»©ng Má» Nháº¡t (Matte)</option>
              <option value="dust_scratches_medium">7. Bá»¥i & Váº¿t XÆ°á»›c (Trung bÃ¬nh)</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ ÃNH SÃNG â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="golden_light_leak">8. RÃ² Rá»‰ Ãnh SÃ¡ng (VÃ ng)</option>
              <option value="sunset_light_leak">9. RÃ² Rá»‰ Ãnh SÃ¡ng (HoÃ ng HÃ´n)</option>
              <option value="soft_bokeh">10. Hiá»‡u á»©ng Bokeh (Má» nháº¹)</option>
              <option value="blue_vignette">11. Tá»‘i GÃ³c (Xanh Láº¡nh)</option>
              <option value="rainbow_prism">12. Vá»‡t LÄƒng KÃ­nh (Cáº§u Vá»“ng)</option>
              <option value="film_burn_top">13. ChÃ¡y Film (Top)</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ KHUNG & HÃŒNH Dáº NG â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="polaroid_border_thin">14. Khung Trong (Polaroid Má»ng)</option>
              <option value="black_frame_thin">15. Viá»n Äen Má»ng</option>
              <option value="white_cross_hatch">16. Gáº¡ch ChÃ©o Tráº¯ng (Texture)</option>
              <option value="heart_shaped_mask">17. Mask HÃ¬nh TrÃ¡i Tim (Viá»n)</option>
              <option value="scribble_corners">18. Váº½ Nguá»‡ch Ngoáº¡c (GÃ³c)</option>
              <option value="tape_strip_top">19. Dáº£i BÄƒng DÃ­nh (Top)</option>
              
              <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€ HIá»†U á»¨NG Äáº¶C BIá»†T â”€â”€â”€â”€â”€â”€â”€â”€</option>
              <option value="holographic_glitch">20. Lá»—i Hologram (Glitch)</option>
              <option value="half_tone_dots">21. Cháº¥m Má»±c (Halftone)</option>
              <option value="glitter_sparkle">22. Láº¥p LÃ¡nh (Giáº£)</option>
            </select>
            </div>
        
        <div class="option-row" style="width:100%; justify-content:flex-start; flex-wrap:nowrap; margin-top:10px;">
          <label class="small" style="white-space:nowrap; margin-left:10px;">Text Strip:</label>
          <input id="customStripText" type="text" value="INSTAX MOMENT" style="flex:1;" maxlength="30" placeholder="VD: INSTAX MOMENT"/>
        </div>
        
        <div class="option-row" style="width:100%; margin-top:10px; margin-bottom: 10px;">
          <label class="small">Layout In áº¢nh:</label>
          <select id="layoutSelect" style="flex:1;">
            <option value="vertical">1. Dá»c (Strip) - Fixed 1:1 Photo</option>
            <option value="grid">2. LÆ°á»›i (2x2) - Fixed 1:1 Photo</option>
          </select>
        </div>
      </div>
      
      <div id="previewAndFinal" class="review-inner">
        
        <div style="font-weight:700; color: #3b2b47;">áº¢NH GHÃ‰P HOÃ€N CHá»ˆNH (MERGE)</div>
        <div class="final-wrap">
          <div>
            <div class="final-preview" id="finalPreview">
              <div class="small">ChÆ°a cÃ³ áº£nh</div>
            </div>
          </div>
          <div id="finalActions" style="display:none; flex-direction:column; gap:8px; align-items:flex-start; padding-top:20px;">
            <div class="small">áº¢nh Ä‘Ã£ ghÃ©p xong. KÃ­ch thÆ°á»›c: <strong id="stripSizeText">Dynamic Size</strong></div>
            <button class="btn" id="downloadFinalBtn">
              <span style="font-size: 1.1em; line-height: 1;">ğŸ“¥</span> Download Final
            </button>
          </div>
        </div>
        <div style="margin-top: 20px;">
            <strong style="color: #3b2b47;">áº¢nh Chá»¥p Gá»‘c (4 pose)</strong>
            <div class="small">Click vÃ o khung áº£nh Ä‘á»ƒ download tá»«ng táº¥m riÃªng</div>
        </div>
        <div class="preview-grid" id="previewGrid" style="margin-top:8px;"></div>
        </div>
    </div>
  </div>

  <footer>Made for you â€” Photobooth Square â€¢ Timezone: Asia/Ho_Chi_Minh</footer>
</div>

<script>
/* ---------- Photobooth (fixed & overlay sizing) ---------- */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const overlayCtx = overlay.getContext('2d');
const previewGrid = document.getElementById('previewGrid');
const finalPreview = document.getElementById('finalPreview'); 
const countdownEl = document.getElementById('countdown');
const layoutSelect = document.getElementById('layoutSelect'); 
const backgroundSelect = document.getElementById('backgroundSelect'); 
const customStripText = document.getElementById('customStripText');
const stripSizeText = document.getElementById('stripSizeText'); 
const finalActionsEl = document.getElementById('finalActions'); 

// NEW VARIABLES FOR OVERLAY/STICKER
const overlaySelect = document.getElementById('overlaySelect'); 
const beautyLevel = document.getElementById('beautyLevel'); // NEW: Cáº¥p Ä‘á»™ lÃ m má»‹n da
// END NEW VARIABLES

// NEW UI ELEMENTS FOR SCREEN SWITCHING
const welcomeScreen = document.getElementById('welcomeScreen');
const captureScreen = document.getElementById('captureScreen');
const reviewScreen = document.getElementById('reviewScreen');
const backToCaptureBtn = document.getElementById('backToCaptureBtn');

// NEW: Capture Controls & Settings elements to disable during the sequence
const startBtn = document.getElementById('startBtn');
const redoBtn = document.getElementById('redoBtn');
const stopCamBtn = document.getElementById('stopCamBtn');
const switchCamBtn = document.getElementById('switchCamBtn');
const refreshBtn = document.getElementById('refreshBtn');
const intervalSec = document.getElementById('intervalSec');
const startPhotoboothBtn = document.getElementById('startPhotoboothBtn'); // NÃºt Báº¯t Äáº§u á»Ÿ mÃ n hÃ¬nh Welcome

const controlsToDisable = [
    startBtn, redoBtn, stopCamBtn, switchCamBtn, refreshBtn, 
    intervalSec, startPhotoboothBtn, beautyLevel
];

let captures = [];
const timeZone = 'Asia/Ho_Chi_Minh';
let stream = null;
let currentFacingMode = 'user'; 
let finalImageDataUrl = null; 

// CONSTANTS
const INNER_BORDER = 5; 
const VERT_GAP = 40; 
const BASE_FRAME_H = 450; 
const VERT_MARGIN_X = 30; 
const VERT_MARGIN_Y = 40; 
const VERT_TEXT_H = 250; 
const GRID_OUTER_PADDING = 40; 
const GRID_GAP = 30; 
const GRID_TEXT_H = 250; 
const FINAL_PHOTO_BORDER_WIDTH = 4; 
const FINAL_PHOTO_BORDER_COLOR = '#333333'; 

// devicePixelRatio helper
function getDPR(){ return window.devicePixelRatio || 1; }

/* -------------------- Tá»¶ Lá»† áº¢NH CHá»¤P (Cá» Äá»ŠNH 1:1) -------------------- */

// HÃ m láº¥y tá»· lá»‡ (W/H) cá»§a khu vá»±c áº£nh bÃªn trong film (dÃ¹ng cho live preview & drawing)
function getInstaxPhotoRatio(frameStyle) {
    return 1.0; 
}

// HÃ m láº¥y tá»· lá»‡ (W/H) cá»§a toÃ n bá»™ film Instax (áº£nh + chÃ¢n tráº¯ng)
function getInstaxFilmRatio(frameStyle) {
    return 1.0;
}

// Cáº­p nháº­t tá»· lá»‡ cho táº¥t cáº£ thumbnails trÃªn mÃ n hÃ¬nh review
function updateThumbnailAspectRatios() {
    const numericRatio = getInstaxFilmRatio('square'); 

    const thumbs = document.querySelectorAll('.instax-thumb-frame');
    thumbs.forEach(thumb => {
        thumb.style.aspectRatio = `${numericRatio} / 1`; 
    });
}

/* ----------------- END Tá»¶ Lá»† áº¢NH CHá»¤P LOGIC ------------------ */


/* --------------- UI SWITCHING LOGIC (GIá»® NGUYÃŠN) --------------- */

function showWelcomeScreen() {
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    welcomeScreen.style.display = 'flex';
    resetAll(); 
    stopCamera(); 
}

function showReviewScreen() {
    welcomeScreen.style.display = 'none';
    captureScreen.style.display = 'none';
    reviewScreen.style.display = 'flex'; 
    
    updateThumbnailAspectRatios(); 

    window.scrollTo({ top: 0, behavior: 'smooth' }); 
}

function showCaptureScreen() {
    welcomeScreen.style.display = 'none';
    reviewScreen.style.display = 'none';
    captureScreen.style.display = 'grid'; 
}

/* --------------- END UI SWITCHING LOGIC --------------- */

// start camera
async function startCamera(){
  try {
    console.log(`YÃªu cáº§u camera: ${currentFacingMode === 'user' ? 'TrÆ°á»›c' : 'Sau'}...`);
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 }, 
        height: { ideal: 720 }, 
        facingMode: currentFacingMode 
      }, 
      audio:false 
    });
    video.srcObject = stream;
    
    await new Promise(resolve => {
        if (video.readyState >= 2) { 
            resolve();
        } else {
            video.addEventListener('loadedmetadata', resolve, { once: true });
        }
    });

    await video.play();
    resizeOverlay(); 
    drawFrameLoop();
    console.log(`Camera ${currentFacingMode === 'user' ? 'TrÆ°á»›c' : 'Sau'} Ä‘Ã£ báº­t`);

    video.style.transform = currentFacingMode === 'user' ? 'scaleX(-1)' : 'none';

  } catch(e) {
    console.error('startCamera error', e);
    const name = e && e.name ? e.name : 'UnknownError';
    const msg = e && e.message ? e.message : String(e);
    alert('KhÃ´ng thá»ƒ truy cáº­p camera: ' + name + ' â€” ' + msg + '\n\nKiá»ƒm tra: (1) cháº¡y trÃªn localhost/https (2) trÃ¬nh duyá»‡t cho phÃ©p quyá»n camera (3) khÃ´ng bá»‹ app khÃ¡c chiáº¿m dá»¥ng).');
  }
}

function stopCamera(){
  try{
    if (stream) {
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
      console.log('Camera Ä‘Ã£ táº¯t');
    }
  } catch(e){}
}

async function switchCamera() {
    if (captures.length > 0) {
        alert('Báº¡n chá»‰ cÃ³ thá»ƒ chuyá»ƒn Ä‘á»•i camera trÆ°á»›c khi báº¯t Ä‘áº§u chá»¥p. HÃ£y báº¥m "Reset áº¢nh Chá»¥p" náº¿u muá»‘n Ä‘á»•i.');
        return;
    }
    if (stream) {
        stopCamera();
    }
    currentFacingMode = (currentFacingMode === 'user' ? 'environment' : 'user');
    await startCamera();
}

function resizeOverlay(){
  const dpr = getDPR();
  const vcw = video.clientWidth;
  const vch = video.clientHeight;
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  
  if (vw === 0 || vh === 0 || vcw === 0 || vch === 0) return;

  const aspect = vw / vh;
  const wrapAspect = vcw / vch;

  let newW, newH, xOffset, yOffset;

  // CÄƒn giá»¯a video trong wrap area (object-fit: cover)
  if (aspect > wrapAspect) {
    // Chiá»u cao lÃ  giá»›i háº¡n
    newH = vch;
    newW = vch * aspect;
    xOffset = (vcw - newW) / 2;
    yOffset = 0;
  } else {
    // Chiá»u rá»™ng lÃ  giá»›i háº¡n
    newW = vcw;
    newH = vcw / aspect;
    xOffset = 0;
    yOffset = (vch - newH) / 2;
  }
  
  // Cáº­p nháº­t kÃ­ch thÆ°á»›c canvas (theo kÃ­ch thÆ°á»›c hiá»ƒn thá»‹ thá»±c táº¿ cá»§a video)
  overlay.width = vcw * dpr;
  overlay.height = vch * dpr;
  overlay.style.width = vcw + 'px';
  overlay.style.height = vch + 'px';

  // Cáº­p nháº­t transformation Ä‘á»ƒ váº½
  overlayCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  overlayCtx.clearRect(0, 0, vcw, vch);

  // Thiáº¿t láº­p biáº¿n transform cho drawing (dÃ¹ng Ä‘á»ƒ váº½ khung áº£nh vÃ  ngÃ y giá»)
  // Biáº¿n nÃ y sáº½ Ä‘Æ°á»£c dÃ¹ng trong drawInstaxGuide
  overlayCtx.globalTransform = {
    scaleX: newW / vw,
    scaleY: newH / vh,
    offsetX: xOffset,
    offsetY: yOffset,
    dpr: dpr,
    vcw: vcw,
    vch: vch
  };
}

function drawFrameLoop(){
    if (stream) {
        drawInstaxGuide(overlayCtx, video.clientWidth, video.clientHeight);
        requestAnimationFrame(drawFrameLoop);
    }
}

function roundRect(ctx, x, y, w, h, r) {
    if (w < 2 * r) r = w / 2;
    if (h < 2 * r) r = h / 2;
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
}

function drawInstaxGuide(ctx, w, h){
    if (!ctx.globalTransform) return;
    ctx.save();
    
    const t = ctx.globalTransform;
    const cw = w;
    const ch = h; 
    
    const targetRatio = getInstaxPhotoRatio('square'); 
    
    let photoW = t.scaleY * video.videoHeight * targetRatio;
    let photoH = t.scaleY * video.videoHeight;
    
    if (photoW > t.scaleX * video.videoWidth) {
        photoW = t.scaleX * video.videoWidth;
        photoH = photoW / targetRatio;
    }
    
    const x_outer = (cw - photoW) / 2;
    const y_outer = (ch - photoH) / 2;
    
    const padding = 10;
    const innerColor = 'rgba(255, 255, 255, 0.9)'; 

    ctx.save();
    ctx.beginPath();
    roundRect(ctx, x_outer - padding, y_outer - padding, photoW + 2 * padding, photoH + 2 * padding, 10);
    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; 
    ctx.fill();
    
    ctx.strokeStyle = innerColor;
    ctx.lineWidth = 2;
    ctx.setLineDash([8, 8]);
    ctx.strokeRect(x_outer, y_outer, photoW, photoH);
    ctx.setLineDash([]);
    
    ctx.font = '16px Nunito, sans-serif';
    ctx.fillStyle = innerColor;
    ctx.textAlign = 'center';
    ctx.fillText('1:1 SQUARE', cw / 2, y_outer - padding - 8); 
    
    ctx.font = '14px Nunito, sans-serif';
    ctx.fillStyle = innerColor;
    ctx.textAlign = 'left';
    ctx.fillText(currentFacingMode === 'user' ? 'CAM TRÆ¯á»šC (SELFIE)' : 'CAM SAU (ENV)', 15, 30);
    
    ctx.restore();
    
    ctx.photoArea = { x: x_outer, y: y_outer, w: photoW, h: photoH };
}

function getFormattedNow(){
    try {
        const now = new Date();
        const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: timeZone };
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: timeZone };
        const datePart = now.toLocaleDateString('en-GB', dateOptions).replace(/\//g, '/');
        const timePart = now.toLocaleTimeString('en-GB', timeOptions);
        return `${datePart} ${timePart}`;
    } catch (e) {
        return '';
    }
}

// ** NEW: Helper function to apply beauty filter **
// Helper function to apply beauty filter (changes pixel data)
function applyBeautyFilter(ctx, x, y, w, h, intensity) {
    if (intensity <= 0) return; // KhÃ´ng lÃ m gÃ¬ náº¿u cÆ°á»ng Ä‘á»™ lÃ  0
    
    // Ãnh xáº¡ cÆ°á»ng Ä‘á»™ (1-6) sang cÃ¡c há»‡ sá»‘
    // Intensity 1 -> 0.02 (Very Light) | 6 -> 0.12 (Very Strong)
    const smoothFactor = intensity * 0.02; 
    
    // Rosy Boost Factor: max 1.10 + 10 (cÆ°á»ng Ä‘á»™ 1), min 1.05 + 5 (cÆ°á»ng Ä‘á»™ 6)
    const rosyBoostFactor = 1.05 + (6 - intensity) * 0.01; 
    const rosyAdditive = 5 + (6 - intensity) * 1; 
    // Äá»™ sÃ¡ng tá»•ng thá»ƒ tÄƒng nháº¹ theo cÆ°á»ng Ä‘á»™
    const brightnessBoost = 1.01 + intensity * 0.005; 

    try {
        const imageData = ctx.getImageData(x, y, w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];

            // 1. Rosy Lips/Cheeks boost (Náº¿u áº£nh cÃ³ thiÃªn hÆ°á»›ng áº¥m)
            if (r > g * 1.05 && r > b * 1.05) { 
                r = Math.min(255, r * rosyBoostFactor + rosyAdditive); 
            }
            
            // 2. Simple 'Smoothing' (LÃ m má»‹n/Glowing): Dá»‹ch chuyá»ƒn nháº¹ mÃ u vá» giÃ¡ trá»‹ trung bÃ¬nh
            const avg = (r + g + b) / 3;
            // Dá»‹ch chuyá»ƒn smoothFactor % giÃ¡ trá»‹ mÃ u vá» mÃ u xÃ¡m trung bÃ¬nh Ä‘á»ƒ giáº£m Ä‘á»™ tÆ°Æ¡ng pháº£n gáº¯t
            r = r + (avg - r) * smoothFactor;
            g = g + (avg - g) * smoothFactor;
            b = b + (avg - b) * smoothFactor;
            
            // 3. Apply slight overall brightness/warmth
            r = Math.min(255, r * brightnessBoost);
            g = Math.min(255, g * brightnessBoost);
            b = Math.min(255, b * brightnessBoost);

            data[i] = r;
            data[i + 1] = g;
            data[i + 2] = b;
        }
        ctx.putImageData(imageData, x, y);
    } catch(e) { 
        console.warn('Could not apply applyBeautyFilter:', e);
    }
}
// ** END NEW: Helper function to apply beauty filter **


// Chá»¥p áº£nh
function captureFrame(video, overlay) {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const canvas = document.createElement('canvas');
    
    const cropSize = vh; 
    const cropX = (vw - cropSize) / 2; 
    
    canvas.width = cropSize; 
    canvas.height = cropSize; 
    const ctx = canvas.getContext('2d');
    
    // Xá»­ lÃ½ transform Ä‘á»ƒ láº­t áº£nh (náº¿u lÃ  camera trÆ°á»›c)
    ctx.save();
    if (currentFacingMode === 'user') {
        ctx.scale(-1, 1);
        ctx.drawImage(video, 
                      cropX, 0, cropSize, cropSize, 
                      -cropSize, 0, cropSize, cropSize);
    } else {
        ctx.drawImage(video, 
                      cropX, 0, cropSize, cropSize, 
                      0, 0, cropSize, cropSize);
    }
    ctx.restore();
    
    // ** NEW: Ãp dá»¥ng LÃ€M Má»ŠN DA (Beauty Filter) trÆ°á»›c tiÃªn **
    const smoothingLevel = parseInt(beautyLevel.value, 10);
    if (smoothingLevel > 0) {
        // Táº¡o má»™t canvas táº¡m Ä‘á»ƒ Ã¡p dá»¥ng smoothing filter pixel-based
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(canvas, 0, 0); // Copy áº£nh Ä‘Ã£ chá»¥p (cÃ²n gá»‘c) sang temp canvas
        
        applyBeautyFilter(tempCtx, 0, 0, tempCanvas.width, tempCanvas.height, smoothingLevel);
        
        // Váº½ ngÆ°á»£c láº¡i áº£nh Ä‘Ã£ lÃ m má»‹n lÃªn canvas chÃ­nh
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(tempCanvas, 0, 0);
    }
    // ** END NEW SMOOTHING **

    // Ãp dá»¥ng Overlay/Filter Ä‘Ã£ chá»n (náº¿u cÃ³)
    const overlayId = overlaySelect.value;
    if (overlayId && overlayId !== 'none') {
        // Táº¡o má»™t canvas táº¡m Ä‘á»ƒ Ã¡p dá»¥ng overlay filter pixel-based
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(canvas, 0, 0); // Copy áº£nh Ä‘Ã£ chá»¥p sang temp canvas
        
        // Ãp dá»¥ng overlay/filter lÃªn tempCtx
        drawOverlayFrame_ORIGINAL(tempCtx, 0, 0, tempCanvas.width, tempCanvas.height, overlayId);
        
        // Váº½ ngÆ°á»£c láº¡i lÃªn canvas chÃ­nh
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(tempCanvas, 0, 0);
    }
    
    return canvas.toDataURL('image/png');
}

// [REPLACEMENT] Bá»• sung Ã¢m thanh Beep/Shutter Ä‘Ã¡ng tin cáº­y báº±ng Web Audio API
function playTone(frequency = 440, duration = 100, volume = 0.5) {
    try {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(context.destination);

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(frequency, context.currentTime);
        gainNode.gain.setValueAtTime(volume, context.currentTime);

        // Fade out for clean stop
        gainNode.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + (duration / 1000));
        
        oscillator.start();
        oscillator.stop(context.currentTime + (duration / 1000));
    } catch(e) { 
        /* ignore - sometimes mobile browsers block audio context without user interaction */
    }
}

function playBeepSound() {
    // Táº§n sá»‘ tiÃªu chuáº©n (Standard beep)
    playTone(440, 150, 0.4); 
}

function playShutterSound() {
    // Táº§n sá»‘ cao hÆ¡n vÃ  ngáº¯n hÆ¡n (Higher pitch for shutter)
    playTone(880, 50, 0.3); 
}
// END REPLACEMENT

// Countdown and Capture Sequence
let captureIndex = 0;
const MAX_CAPTURES = 4;
let isCapturing = false;

function disableControls() {
    controlsToDisable.forEach(el => el.disabled = true);
}
function enableControls() {
    controlsToDisable.forEach(el => el.disabled = false);
}

function flashEffect(){
    const flash = document.createElement('div');
    flash.style.cssText = 'position:absolute; inset:0; background:white; opacity:0; pointer-events:none; transition:opacity 0.1s linear;';
    document.getElementById('cameraWrap').appendChild(flash);
    setTimeout(()=>{
        flash.style.opacity = '1';
        setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => flash.remove(), 200);
        }, 100);
    }, 10);
}

function startPhotobooth(){
    if (isCapturing || stream === null) return;
    
    resetAll();
    captureIndex = 0;
    isCapturing = true;
    disableControls();
    
    // Khoáº£ng thá»i gian nghá»‰ sau khi chá»¥p xong má»—i pose (Pose 1, 2, 3)
    const userInterval = parseInt(intervalSec.value, 10);
    // Äáº£m báº£o thá»i gian nghá»‰ náº±m trong khoáº£ng [1, 10]
    const intervalDelaySec = Math.min(10, Math.max(1, userInterval)); 
    
    // Äáº¿m ngÆ°á»£c cá»‘ Ä‘á»‹nh trÆ°á»›c má»—i pose
    const fixedCountdownSec = 3; 

    // NEW: HÃ m Ä‘áº¿m ngÆ°á»£c thá»i gian nghá»‰ vÃ  gá»i doCapture cho pose tiáº¿p theo
    const startRestPeriod = (nextIndex, seconds) => {
        countdownEl.style.display = 'flex';
        // Giáº£m cá»¡ chá»¯ Ä‘á»ƒ chá»©a thÃ´ng bÃ¡o Ä‘a dÃ²ng
        countdownEl.style.fontSize = '40px'; 
        let count = seconds;
        
        // Hiá»‡n thÃ´ng bÃ¡o ban Ä‘áº§u
        countdownEl.innerHTML = `CHUáº¨N Bá»Š POSE ${nextIndex + 1} (Nghá»‰ ${count}s)` + 
                                `<div style="font-size: 72px; font-weight: 800; margin-top: 10px;">${count}</div>`;
        playBeepSound(); 

        const restTimer = setInterval(() => {
            count--;
            
            if (count >= 0) {
                // Cáº­p nháº­t sá»‘ giÃ¢y cÃ²n láº¡i
                countdownEl.innerHTML = `CHUáº¨N Bá»Š POSE ${nextIndex + 1} (Nghá»‰ ${count}s)` + 
                                        `<div style="font-size: 72px; font-weight: 800; margin-top: 10px;">${count}</div>`;
                playBeepSound(); 
            }
            
            if (count < 0) {
                clearInterval(restTimer);
                // KhÃ´i phá»¥c cá»¡ chá»¯ vÃ  báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c cá»‘ Ä‘á»‹nh
                countdownEl.style.fontSize = '92px'; 
                doCapture(nextIndex); 
            }
        }, 1000);
    }
    // END NEW
    
    const doCapture = (index) => {
        if (index >= MAX_CAPTURES) {
            // ÄÃ¢y lÃ  pháº§n dá»n dáº¹p cuá»‘i cÃ¹ng náº¿u logic á»Ÿ dÆ°á»›i khÃ´ng gá»i
            isCapturing = false;
            enableControls();
            showReviewScreen();
            mergeAndShowFinal();
            return;
        }
        
        // BÆ¯á»šC 1: Äáº¿m ngÆ°á»£c 3 giÃ¢y trÆ°á»›c má»—i láº§n chá»¥p
        countdownEl.style.display = 'flex';
        // Äáº£m báº£o cá»¡ chá»¯ lÃ  92px cho 3, 2, 1
        countdownEl.style.fontSize = '92px'; 
        let count = fixedCountdownSec;
        countdownEl.textContent = count;
        
        if (count > 0) {
            playBeepSound(); 
        }

        const timer = setInterval(() => {
            count--;
            
            if (count > 0) {
                countdownEl.textContent = count;
                playBeepSound(); 
            } else if (count === 0) {
                countdownEl.textContent = 'CHá»¤P!'; 
                playBeepSound(); 
            } else {
                clearInterval(timer);
                countdownEl.style.display = 'none';
                
                // BÆ¯á»šC 2: CHá»¤P VÃ€ HIá»‚N THá»Š
                const imgDataUrl = captureFrame(video, overlay);
                captures.push(imgDataUrl);
                addThumbnail(imgDataUrl, index + 1);
                
                flashEffect();
                playShutterSound();
                
                // BÆ¯á»šC 3: NGHá»ˆ KHOáº¢NG THá»œI GIAN NGÆ¯á»œI DÃ™NG SET (chá»‰ nghá»‰ náº¿u chÆ°a pháº£i pose cuá»‘i)
                if (index < MAX_CAPTURES - 1) {
                    // Má»šI: Gá»i hÃ m Ä‘áº¿m ngÆ°á»£c thá»i gian nghá»‰ (intervalDelaySec Ä‘Ã£ lÃ  sá»‘ giÃ¢y)
                    startRestPeriod(index + 1, intervalDelaySec);
                } else {
                    // Náº¿u lÃ  pose cuá»‘i cÃ¹ng, khÃ´ng cáº§n nghá»‰, chuyá»ƒn sang mÃ n hÃ¬nh review
                    isCapturing = false;
                    enableControls();
                    showReviewScreen();
                    mergeAndShowFinal();
                }
            }
        }, 1000);
    };

    // Báº¯t Ä‘áº§u chuá»—i vá»›i Pose 1
    doCapture(0);
}

function backToWelcome() {
    stopCamera(); 
    showWelcomeScreen();
}

/* ---------------- OVERLAY/FILTER LOGIC (UNCHANGED) ---------------- */

// Helper function for film grain (changes pixel data)
function addGrain(alpha, x, y, w, h, ctx) {
    try {
        const imageData = ctx.getImageData(x, y, w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const grain = (Math.random() - 0.5) * 50 * alpha; 
            data[i] = Math.min(255, Math.max(0, data[i] + grain));
            data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + grain));
            data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + grain));
        }
        ctx.putImageData(imageData, x, y);
    } catch(e) {
        console.warn('Could not apply addGrain:', e);
    }
}

// Helper function to apply sepia (changes pixel data)
function applySepia(ctx, x, y, w, h) {
    try {
        const imageData = ctx.getImageData(x, y, w, h);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];
            
            data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189)); // R
            data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168)); // G
            data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131)); // B
        }
        ctx.putImageData(imageData, x, y);
    } catch(e) {
        console.warn('Could not apply applySepia:', e);
    }
}

function addScratches(intensity, color, ctx, x, y, w, h) {
    // Add light scratches (lines)
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1 * intensity;
    ctx.globalAlpha = 0.5 * intensity;
    for (let i = 0; i < 10 * intensity; i++) {
        const startX = x + Math.random() * w;
        const startY = y + Math.random() * h;
        const length = w * (0.1 + Math.random() * 0.3);
        const angle = Math.random() * Math.PI * 2;
        const endX = startX + length * Math.cos(angle);
        const endY = startY + length * Math.sin(angle);
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
    }
    ctx.restore();
}

// Draw Overlay on Photo Area
function drawOverlayFrame_ORIGINAL(ctx, x, y, w, h, overlayId){
    if (overlayId === 'none') return;
    
    ctx.save();
    // Set clip path to the photo area
    ctx.beginPath();
    ctx.rect(x, y, w, h);
    ctx.clip();
    
    // ** LÆ¯U Ã: Hiá»‡u á»©ng lÃ m má»‹n da Ä‘Ã£ Ä‘Æ°á»£c Ã¡p dá»¥ng trong captureFrame() **
    
    // Náº¿u lÃ  filter pixel-based khÃ¡c (Sepia, Grain), Ã¡p dá»¥ng trÆ°á»›c khi váº½ khung
    switch(overlayId) {
        case 'film_grain_light':
            addGrain(0.3, x, y, w, h, ctx);
            break;
        case 'film_grain_heavy':
            addGrain(0.8, x, y, w, h, ctx);
            break;
        case 'vintage_sepia_light':
            applySepia(ctx, x, y, w, h);
            // Subtle White overlay for fading
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(x, y, w, h);
            break;
    }
    
    // Ãp dá»¥ng Overlay/Filter cÃ²n láº¡i (váº½ hÃ¬nh há»c/mÃ u sáº¯c)
    switch(overlayId){
        case 'heart_corners':
            const size = Math.min(w, h) * 0.1;
            ctx.fillStyle = '#FF69B4'; // Hot Pink
            ctx.globalAlpha = 0.8;
            ctx.save();
            // Top-Left
            ctx.beginPath();
            roundRect(ctx, x, y, size, size, 5); 
            ctx.fill();
            // Top-Right (mirror X)
            ctx.translate(x + w, 0);
            ctx.scale(-1, 1);
            ctx.beginPath();
            roundRect(ctx, 0, y, size, size, 5); 
            ctx.fill();
            // Bottom-Left (mirror Y)
            ctx.translate(-(x + w), 0);
            ctx.translate(0, y + h);
            ctx.scale(1, -1);
            ctx.beginPath();
            roundRect(ctx, x, 0, size, size, 5); 
            ctx.fill();
            // Bottom-Right (mirror X, Y)
            ctx.translate(x + w, 0);
            ctx.scale(-1, 1);
            ctx.beginPath();
            roundRect(ctx, 0, 0, size, size, 5); 
            ctx.fill();
            
            ctx.restore();
            ctx.globalAlpha = 1;
            break;
        case 'film_damage':
            // Simple film dust/scratches overlay
            ctx.fillStyle = 'rgba(0,0,0,0.1)'; // Add dust/specks
            for (let i = 0; i < 50; i++) {
                ctx.fillRect(x + Math.random() * w, y + Math.random() * h, 1, 1);
            }
            // Add light scratches
            addScratches(1, 'rgba(255,255,255,0.2)', ctx, x, y, w, h);
            break;
        // ---------------------------------
        case 'faded_matte':
            // LÃ m tá»‘i gÃ³c (Vignette)
            const vignetteGrad = ctx.createRadialGradient(x + w/2, y + h/2, Math.min(w,h)/4, x + w/2, y + h/2, Math.min(w,h)/2);
            vignetteGrad.addColorStop(0, 'rgba(0,0,0,0)');
            vignetteGrad.addColorStop(1, 'rgba(0,0,0,0.4)');
            ctx.fillStyle = vignetteGrad;
            ctx.fillRect(x, y, w, h);
            // Matte effect: TÄƒng Ä‘á»™ sÃ¡ng kÃªnh tá»‘i
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.globalCompositeOperation = 'soft-light'; // Ãp dá»¥ng sÃ¡ng nháº¹
            ctx.fillRect(x, y, w, h);
            ctx.globalCompositeOperation = 'source-over';
            break;
        case 'dust_scratches_medium':
            // Bá»¥i & Váº¿t xÆ°á»›c trung bÃ¬nh
            ctx.fillStyle = 'rgba(0,0,0,0.15)'; // Dust/specks
            for (let i = 0; i < 100; i++) {
                ctx.fillRect(x + Math.random() * w, y + Math.random() * h, 1, 1);
            }
            addScratches(2, 'rgba(255,255,255,0.3)', ctx, x, y, w, h); // Scratches
            break;
        
        // ---------------------------------
        // â”€â”€â”€â”€â”€â”€â”€â”€ ÃNH SÃNG â”€â”€â”€â”€â”€â”€â”€â”€
        // ---------------------------------
        case 'golden_light_leak':
            // Ãnh sÃ¡ng rÃ² rá»‰ vÃ ng áº¥m
            ctx.globalCompositeOperation = 'screen'; 
            ctx.globalAlpha = 0.6;
            const goldenGrad = ctx.createRadialGradient(x + w*0.8, y + h*0.2, w*0.05, x + w*0.8, y + h*0.2, w*0.4);
            goldenGrad.addColorStop(0, '#FFD700'); // Gold
            goldenGrad.addColorStop(1, 'rgba(255, 255, 0, 0)'); // White
            ctx.fillStyle = goldenGrad;
            ctx.fillRect(x, y, w, h);
            break;
        case 'sunset_light_leak':
            // Ãnh sÃ¡ng hoÃ ng hÃ´n (há»“ng cam)
            ctx.globalCompositeOperation = 'screen'; 
            ctx.globalAlpha = 0.7;
            const sunsetGrad = ctx.createRadialGradient(x + w*0.1, y + h*0.9, w*0.05, x + w*0.1, y + h*0.9, w*0.5);
            sunsetGrad.addColorStop(0, '#FF4500'); // Orange Red
            sunsetGrad.addColorStop(1, 'rgba(255, 105, 180, 0)'); // Hot Pink
            ctx.fillStyle = sunsetGrad;
            ctx.fillRect(x, y, w, h);
            break;
        case 'soft_bokeh':
            // VÃ i vÃ²ng trÃ²n má»
            ctx.globalCompositeOperation = 'overlay';
            ctx.globalAlpha = 0.5;
            const bokehColors = ['#FFC0CB', '#ADD8E6', '#90EE90'];
            for(let i=0; i<5; i++) {
                const cx = x + Math.random() * w;
                const cy = y + Math.random() * h;
                const r = Math.min(w,h) * (Math.random() * 0.1 + 0.05);
                ctx.fillStyle = bokehColors[i % 3];
                // Faking blur with transparent radial gradient
                const bGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
                bGrad.addColorStop(0, ctx.fillStyle);
                bGrad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = bGrad;
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, 2 * Math.PI);
                ctx.fill();
            }
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        case 'blue_vignette':
            const blueGrad = ctx.createRadialGradient(x + w/2, y + h/2, Math.min(w,h)*0.3, x + w/2, y + h/2, Math.min(w,h)*0.5);
            blueGrad.addColorStop(0, 'rgba(0,0,0,0)');
            blueGrad.addColorStop(1, 'rgba(0,50,100,0.6)'); // Dark Blue
            ctx.fillStyle = blueGrad;
            ctx.fillRect(x, y, w, h);
            break;
        case 'rainbow_prism':
            ctx.globalCompositeOperation = 'overlay';
            ctx.globalAlpha = 0.4;
            const prismGrad = ctx.createLinearGradient(x, y, x + w, y + h);
            prismGrad.addColorStop(0, 'rgba(255,0,0,0.5)');
            prismGrad.addColorStop(0.25, 'rgba(255,255,0,0.5)');
            prismGrad.addColorStop(0.5, 'rgba(0,255,0,0.5)');
            prismGrad.addColorStop(0.75, 'rgba(0,0,255,0.5)');
            prismGrad.addColorStop(1, 'rgba(255,0,255,0.5)');
            ctx.fillStyle = prismGrad;
            ctx.fillRect(x, y, w, h);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        case 'film_burn_top':
            // ChÃ¡y film (Ä‘á»/cam á»Ÿ trÃªn cÃ¹ng)
            ctx.globalCompositeOperation = 'screen';
            ctx.globalAlpha = 0.7;
            const burnGrad = ctx.createLinearGradient(x, y, x, y + h * 0.3);
            burnGrad.addColorStop(0, '#FF4500'); // Orange Red
            burnGrad.addColorStop(0.5, '#FFD700'); // Gold
            burnGrad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = burnGrad;
            ctx.fillRect(x, y, w, h);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        
        // ---------------------------------
        // â”€â”€â”€â”€â”€â”€â”€â”€ KHUNG & HÃŒNH Dáº NG â”€â”€â”€â”€â”€â”€â”€â”€
        // ---------------------------------
        case 'polaroid_border_thin':
            // Khung Ä‘en má»ng bÃªn trong
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = w * 0.05; // 5% border
            ctx.strokeRect(x, y, w, h);
            break;
        case 'black_frame_thin':
            // Khung Ä‘en má»ng bÃªn trong
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2; 
            ctx.strokeRect(x, y, w, h);
            break;
        case 'white_cross_hatch':
            // Há»a tiáº¿t gáº¡ch chÃ©o tráº¯ng (Texture)
            ctx.globalAlpha = 0.3;
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 1;
            const spacing = w / 20;
            for(let i = 0; i < w + h; i += spacing) {
                // ChÃ©o trÃ¡i
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x, y + i);
                ctx.stroke();
                // ChÃ©o pháº£i
                ctx.beginPath();
                ctx.moveTo(x + w - i, y);
                ctx.lineTo(x + w, y + i);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            break;
        case 'heart_shaped_mask':
            const maskSize = Math.min(w, h) * 0.8;
            const maskCX = x + w/2;
            const maskCY = y + h/2 - maskSize * 0.1; // Dá»‹ch lÃªn má»™t chÃºt
            
            // Mask báº±ng cÃ¡ch váº½ hÃ¬nh chá»¯ nháº­t trÆ°á»›c
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; // MÃ u tá»‘i/má» cho mask
            ctx.fillRect(x, y, w, h);

            // XÃ³a hÃ¬nh trÃ¡i tim khá»i mask (globalCompositeOperation = 'destination-out')
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = '#FFFFFF'; // MÃ u tráº¯ng sáº½ bá»‹ xÃ³a
            const drawHeartMask = (cx, cy, s) => {
                ctx.beginPath();
                ctx.moveTo(cx, cy + s * 0.3);
                ctx.bezierCurveTo(cx + s * 0.5, cy - s * 0.8, cx + s * 1.0, cy - s * 0.4, cx, cy + s * 0.6);
                ctx.bezierCurveTo(cx - s * 1.0, cy - s * 0.4, cx - s * 0.5, cy - s * 0.8, cx, cy + s * 0.3);
                ctx.fill();
            };
            drawHeartMask(maskCX, maskCY, maskSize);

            // Váº½ viá»n trÃ¡i tim
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = '#FF69B4'; // Hot Pink
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(maskCX, maskCY + maskSize * 0.3);
            ctx.bezierCurveTo(maskCX + maskSize * 0.5, maskCY - maskSize * 0.8, maskCX + maskSize * 1.0, maskCY - maskSize * 0.4, maskCX, maskCY + maskSize * 0.6);
            ctx.bezierCurveTo(maskCX - maskSize * 1.0, maskCY - maskSize * 0.4, maskCX - maskSize * 0.5, maskCY - maskSize * 0.8, maskCX, maskCY + maskSize * 0.3);
            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over';
            break;
        case 'scribble_corners':
            ctx.strokeStyle = '#333333'; // MÃ u váº½ nguá»‡ch ngoáº¡c
            ctx.lineWidth = 3;
            const scribbleSize = Math.min(w, h) * 0.1;
            const scribble = (startX, startY, endX, endY) => {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.quadraticCurveTo(
                    startX + (endX - startX) * Math.random(), 
                    startY + (endY - startY) * Math.random(), 
                    endX, 
                    endY
                );
                ctx.stroke();
            };
            // Top-Left
            scribble(x, y, x + scribbleSize, y);
            scribble(x, y, x, y + scribbleSize);
            // Top-Right
            scribble(x + w, y, x + w - scribbleSize, y);
            scribble(x + w, y, x + w, y + scribbleSize);
            // Bottom-Left
            scribble(x, y + h, x + scribbleSize, y + h);
            scribble(x, y + h, x, y + h - scribbleSize);
            // Bottom-Right
            scribble(x + w, y + h, x + w - scribbleSize, y + h);
            scribble(x + w, y + h, x + w, y + h - scribbleSize);
            break;
        case 'tape_strip_top':
            ctx.fillStyle = 'rgba(255,255,255,0.7)'; // White/transparent tape
            const tapeHeight = h * 0.08;
            ctx.fillRect(x, y, w, tapeHeight);
            // Váº½ viá»n xÆ°á»›c (Tape Edge simulation)
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            for(let i = 0; i < w; i += 5) {
                ctx.beginPath();
                ctx.moveTo(x + i, y + tapeHeight - (Math.random() * 5));
                ctx.lineTo(x + i + 5, y + tapeHeight - (Math.random() * 5));
                ctx.stroke();
            }
            break;
        
        // ---------------------------------
        // â”€â”€â”€â”€â”€â”€â”€â”€ HIá»†U á»¨NG Äáº¶C BIá»†T â”€â”€â”€â”€â”€â”€â”€â”€
        // ---------------------------------
        case 'holographic_glitch':
            // Glitch effect: Dá»‹ch chuyá»ƒn kÃªnh mÃ u
            const imageDataGlitch = ctx.getImageData(x, y, w, h);
            const dataGlitch = imageDataGlitch.data;
            const offset = 5; 
            // Dá»‹ch chuyá»ƒn kÃªnh Äá» (R)
            for (let i = 0; i < dataGlitch.length; i += 4) {
                if ((i / 4) % w < w - offset) {
                    dataGlitch[i] = dataGlitch[i + 4 * offset];
                }
            }
            // Dá»‹ch chuyá»ƒn kÃªnh Xanh Lam (B)
            for (let i = dataGlitch.length - 4; i >= 0; i -= 4) {
                if ((i / 4) % w >= offset) {
                    dataGlitch[i + 2] = dataGlitch[i - 4 * offset + 2];
                }
            }
            ctx.putImageData(imageDataGlitch, x, y);
            // ThÃªm vá»‡t nhiá»…u Holographic (mÃ u sáº¯c)
            ctx.globalCompositeOperation = 'screen';
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = '#00FFFF'; // Cyan
            ctx.fillRect(x + 2, y + h * 0.3, w, 5);
            ctx.fillStyle = '#FF00FF'; // Magenta
            ctx.fillRect(x - 2, y + h * 0.6, w, 5);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        case 'half_tone_dots':
            // Cháº¥m má»±c (Halftone)
            ctx.globalCompositeOperation = 'multiply';
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            const dotGrid = w / 15;
            for(let i=0; i<w; i+=dotGrid) {
                for(let j=0; j<h; j+=dotGrid) {
                    // KÃ­ch thÆ°á»›c cháº¥m dá»±a trÃªn Ä‘á»™ sÃ¡ng (giáº£ láº­p)
                    const dotSize = Math.random() * (dotGrid / 2); 
                    ctx.beginPath();
                    ctx.arc(x + i, y + j, dotSize, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            ctx.globalCompositeOperation = 'source-over';
            break;
        case 'glitter_sparkle':
            // Láº¥p lÃ¡nh (Giáº£)
            ctx.globalCompositeOperation = 'lighter';
            ctx.globalAlpha = 0.6;
            const sparkleColors = ['#FFFF00', '#FFC0CB', '#FFFFFF'];
            for(let i=0; i<80; i++) {
                const cx = x + Math.random() * w;
                const cy = y + Math.random() * h;
                const size = Math.random() * 2 + 1;
                ctx.fillStyle = sparkleColors[i % 3];
                ctx.fillRect(cx, cy, size, size);
            }
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        default:
            // Do nothing
            break;
    }
    
    ctx.restore();
}

// HÃ m táº£i áº£nh
function loadImg(dataUrl) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = dataUrl;
    });
}

// NEW HELPER FUNCTIONS FOR BACKGROUNDS (Used in drawComplexBackground)
function drawStripes(ctx, W, H, color1, color2) {
    const stripeWidth = W / 10;
    const numStripes = Math.ceil(W / stripeWidth);
    for(let i=0; i<numStripes; i++) {
        ctx.fillStyle = i % 2 === 0 ? color1 : color2;
        ctx.fillRect(i * stripeWidth, 0, stripeWidth, H);
    }
}

function drawDots(ctx, W, H, dotColor, dotSize, spacing, alpha) {
    ctx.save();
    ctx.globalAlpha = alpha || 1;
    ctx.fillStyle = dotColor;
    for(let x = 0; x < W + spacing; x += spacing) {
        for(let y = 0; y < H + spacing; y += spacing) {
            ctx.beginPath();
            ctx.arc(x + Math.random() * (spacing/2), y + Math.random() * (spacing/2), dotSize, 0, 2 * Math.PI);
            ctx.fill();
        }
    }
    ctx.restore();
}

function drawCheckerboard(ctx, W, H, color1, color2, size) {
    ctx.save();
    const numBlocksX = Math.ceil(W / size);
    const numBlocksY = Math.ceil(H / size);
    for (let i = 0; i < numBlocksX; i++) {
        for (let j = 0; j < numBlocksY; j++) {
            const color = (i + j) % 2 === 0 ? color1 : color2;
            ctx.fillStyle = color;
            ctx.fillRect(i * size, j * size, size, size);
        }
    }
    ctx.restore();
}

function drawWatercolorHeart(ctx, cx, cy, s, color) {
    ctx.save();
    // Faking soft edge with radial gradient
    const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, s * 0.7);
    grad.addColorStop(0, color);
    // Note: Assuming color is in rgba() or r,g,b format where '1)' is the alpha part for simple string manipulation
    const finalColor = color.includes('rgba') ? color.replace(/, 0\.9\)/, ', 0)') : color; 
    grad.addColorStop(1, finalColor);
    ctx.fillStyle = grad;
    ctx.globalAlpha = 0.5;
    
    ctx.beginPath();
    // Heart shape approximation
    ctx.moveTo(cx, cy + s * 0.3);
    ctx.bezierCurveTo(cx + s * 0.5, cy - s * 0.8, cx + s * 1.0, cy - s * 0.4, cx, cy + s * 0.6);
    ctx.bezierCurveTo(cx - s * 1.0, cy - s * 0.4, cx - s * 0.5, cy - s * 0.8, cx, cy + s * 0.3);
    ctx.fill();
    ctx.restore();
}
// END NEW HELPER FUNCTIONS

// ---------------- BACKGROUNDS & MERGE LOGIC ---------------- //
// HÃ m váº½ background phá»©c táº¡p (Ã¡p dá»¥ng cho toÃ n bá»™ strip)
function drawComplexBackground(ctx, W, H, backgroundId, layout, textStripYStart, textStripHeight){
    ctx.save();
    // 1. Äáº£m báº£o toÃ n bá»™ canvas Ä‘Æ°á»£c fill mÃ u tráº¯ng hoáº·c mÃ u ná»n chÃ­nh
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, W, H);
    
    // 2. Váº½ Background theo ID
    switch(backgroundId) {
        // ------------------------------ Táº¾T NGUYÃŠN ÄÃN 2026 ------------------------------
        case 'tet_red_gold_silk': {
            ctx.fillStyle = '#B31B1B'; // Deep Red
            ctx.fillRect(0, 0, W, H);
            
            // ThÃªm hiá»‡u á»©ng lá»¥a/gold (simple)
            ctx.globalCompositeOperation = 'overlay';
            ctx.globalAlpha = 0.3;
            const grad = ctx.createLinearGradient(0, 0, W, H);
            grad.addColorStop(0, '#FFD700'); // Gold
            grad.addColorStop(1, '#FFFFFF'); // White
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            
            // ThÃªm Ã¡nh kim láº¥p lÃ¡nh nháº¹ (simple noise)
            addGrain(0.08, 0, 0, W, H, ctx);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        }
        case 'tet_cherry_blossom': {
            ctx.fillStyle = '#FFF0F5'; // Lavender Blush
            ctx.fillRect(0, 0, W, H);
            // Há»a tiáº¿t hoa mai/Ä‘Ã o
            ctx.globalAlpha = 0.6;
            ctx.fillStyle = 'rgba(255, 192, 203, 0.4)'; // Pink petal
            const petalSize = W / 20;
            for(let i=0; i<80; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * W, Math.random() * H, petalSize, 0, 2 * Math.PI);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            break;
        }
        case 'tet_banh_chung_green': {
            ctx.fillStyle = '#38761D'; // Dark Forest Green (LÃ¡ chuá»‘i)
            ctx.fillRect(0, 0, W, H);
            // ThÃªm texture nháº¹
            addGrain(0.1, 0, 0, W, H, ctx);
            break;
        }
        case 'tet_firecracker_pattern': {
            ctx.fillStyle = '#000080'; // Navy Blue
            ctx.fillRect(0, 0, W, H);
            // Há»a tiáº¿t phÃ¡o bÃ´ng (gold/red dots)
            drawDots(ctx, W, H, '#FFD700', W/80, W/15, 0.7);
            drawDots(ctx, W, H, '#FF0000', W/100, W/15, 0.7);
            break;
        }
        case 'tet_lucky_money': {
            const grad = ctx.createLinearGradient(0, 0, W, H);
            grad.addColorStop(0, '#C93C37'); // Deep Red
            grad.addColorStop(1, '#FF7F50'); // Coral (Goldish tone)
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            // ThÃªm texture tiá»n lÃ¬ xÃ¬ (simple noise)
            addGrain(0.15, 0, 0, W, H, ctx);
            break;
        }
        case 'tet_golden_dragon': {
            const grad = ctx.createLinearGradient(0, 0, W, H);
            grad.addColorStop(0, '#FFD700'); // Gold
            grad.addColorStop(1, '#FFA500'); // Orange
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            // Faking scale texture
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = '#000000';
            const size = W / 15;
            for(let x = 0; x < W; x += size) {
                for(let y = 0; y < H; y += size) {
                    ctx.beginPath();
                    ctx.arc(x, y, size/4, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            ctx.globalAlpha = 1;
            break;
        }
        case 'tet_bamboo_stripes': {
            drawStripes(ctx, W, H, '#D4F0C0', '#6B8E23'); // Pale Green / Olive Green
            break;
        }
        case 'tet_lantern_glow': {
            const grad = ctx.createRadialGradient(W*0.5, H*0.5, W*0.1, W*0.5, H*0.5, W*0.5);
            grad.addColorStop(0, '#FFD700'); // Gold (Center)
            grad.addColorStop(1, '#8B0000'); // Dark Red (Edge)
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            break;
        }
        case 'tet_calligraphy_paper': {
            ctx.fillStyle = '#8B0000'; // Dark Red
            ctx.fillRect(0, 0, W, H);
            // Texture giáº¥y
            addGrain(0.1, 0, 0, W, H, ctx);
            break;
        }
        case 'tet_minimal_auspice': {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);
            drawDots(ctx, W, H, 'rgba(255, 215, 0, 0.5)', W/100, W/10, 1);
            drawDots(ctx, W, H, 'rgba(255, 0, 0, 0.5)', W/100, W/10, 1);
            break;
        }
        
        // ------------------------------ GIÃNG SINH ------------------------------
        case 'xmas_red_white_stripes': {
            drawStripes(ctx, W, H, '#FF0000', '#FFFFFF'); // Red / White
            break;
        }
        case 'xmas_pine_forest_green': {
            ctx.fillStyle = '#013220'; // Deep Forest Green
            ctx.fillRect(0, 0, W, H);
            break;
        }
        case 'xmas_snowy_bokeh': {
            ctx.fillStyle = '#191970'; // Midnight Blue
            ctx.fillRect(0, 0, W, H);
            // Bokeh/Snow effect
            ctx.globalAlpha = 0.6;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            for(let i=0; i<50; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * W, Math.random() * H, W/50, 0, 2 * Math.PI);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            break;
        }
        case 'xmas_gold_glitter': {
            ctx.fillStyle = '#B8860B'; // DarkGoldenrod
            ctx.fillRect(0, 0, W, H);
            // Glitter (heavy grain/noise)
            addGrain(0.8, 0, 0, W, H, ctx);
            break;
        }
        case 'xmas_cozy_knit': {
            ctx.fillStyle = '#FAF0E6'; // Linen (Base Color)
            ctx.fillRect(0, 0, W, H);
            // Faking knit lines (simple diagonal)
            ctx.globalAlpha = 0.3;
            ctx.strokeStyle = '#8B0000'; // Dark Red
            ctx.lineWidth = W / 80;
            for(let x = 0; x < W + H; x += W/15) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x - H, H);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            break;
        }
        case 'xmas_gingerbread': {
            ctx.fillStyle = '#8B4513'; // Saddle Brown
            ctx.fillRect(0, 0, W, H);
            // Icing texture (light)
            addGrain(0.1, 0, 0, W, H, ctx);
            break;
        }
        case 'xmas_santa_suit': {
            ctx.fillStyle = '#B22222'; // Firebrick Red
            ctx.fillRect(0, 0, W, H);
            // NÃºt tráº¯ng (simple)
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(W/2 - W/20, H/2 - W/20, W/10, W/10);
            break;
        }
        case 'xmas_holly_berries': {
            ctx.fillStyle = '#F0FFF0'; // Honeydew
            ctx.fillRect(0, 0, W, H);
            drawDots(ctx, W, H, '#006400', W/50, W/10, 0.7); // Green Leaves (large dots)
            drawDots(ctx, W, H, '#8B0000', W/100, W/10, 1); // Red Berries (small dots)
            break;
        }
        case 'xmas_minimal_white': {
            ctx.fillStyle = '#F5F5F5'; // White Smoke
            ctx.fillRect(0, 0, W, H);
            // Subtle snow effect (tiny white dots)
            drawDots(ctx, W, H, 'rgba(255, 255, 255, 0.7)', 1, 10, 1);
            break;
        }
        case 'xmas_twinkle_lights': {
            ctx.fillStyle = '#1C1C1C'; // Dark Grey
            ctx.fillRect(0, 0, W, H);
            // Scattered colored lights
            const lightColors = ['#FFD700', '#FF0000', '#00FF00', '#ADD8E6'];
            ctx.globalAlpha = 0.8;
            for(let i=0; i<30; i++) {
                ctx.fillStyle = lightColors[i % lightColors.length];
                ctx.beginPath();
                ctx.arc(Math.random() * W, Math.random() * H, W/80, 0, 2 * Math.PI);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            break;
        }
        
        // ------------------------------ TÃŒNH YÃŠU ------------------------------
        case 'love_hot_pink_blur': {
            const grad = ctx.createRadialGradient(W*0.5, H*0.5, W*0.1, W*0.5, H*0.5, W*0.5);
            grad.addColorStop(0, '#FF69B4'); // Hot Pink
            grad.addColorStop(1, '#FFC0CB'); // Pink
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            // Blur effect (simple noise/grain)
            addGrain(0.2, 0, 0, W, H, ctx);
            break;
        }
        case 'love_watercolor_hearts': {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);
            const heartSize = W / 10;
            const heartColors = ['rgba(255, 105, 180, 0.9)', 'rgba(255, 0, 0, 0.9)'];
            // Draw hearts (less transparent to ensure visible)
            for(let i=0; i<10; i++) {
                drawWatercolorHeart(ctx, Math.random() * W, Math.random() * H, heartSize, heartColors[i % 2]);
            }
            break;
        }
        case 'love_rose_petals': {
            const grad = ctx.createLinearGradient(0, 0, W, H);
            grad.addColorStop(0, '#800000'); // Maroon
            grad.addColorStop(1, '#FFC0CB'); // Pink
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            break;
        }
        case 'love_scribble_lines': {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);
            ctx.globalAlpha = 0.5;
            ctx.strokeStyle = '#FF0000'; // Red
            ctx.lineWidth = 1;
            for(let i=0; i<20; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * W, Math.random() * H);
                ctx.lineTo(Math.random() * W, Math.random() * H);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            break;
        }
        case 'love_velvet_magenta': {
            ctx.fillStyle = '#800080'; // Purple
            ctx.fillRect(0, 0, W, H);
            // Velvet texture (soft grain)
            addGrain(0.2, 0, 0, W, H, ctx);
            break;
        }
        case 'love_couple_galaxy': {
            ctx.fillStyle = '#191970'; // Midnight Blue
            ctx.fillRect(0, 0, W, H);
            // Starry/Nebula effect
            ctx.globalCompositeOperation = 'lighter';
            ctx.globalAlpha = 0.5;
            const starColors = ['#FFC0CB', '#ADD8E6', '#FFFFFF'];
            for(let i=0; i<50; i++) {
                ctx.fillStyle = starColors[i % 3];
                ctx.beginPath();
                ctx.arc(Math.random() * W, Math.random() * H, Math.random() * 2, 0, 2 * Math.PI);
                ctx.fill();
            }
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            break;
        }
        case 'love_checkerboard_pink': {
            drawCheckerboard(ctx, W, H, '#FFC0CB', '#FFFFFF', W / 10); // Pink / White
            break;
        }
        case 'love_soft_peach_glow': {
            const grad = ctx.createRadialGradient(W*0.5, H*0.5, W*0.1, W*0.5, H*0.5, W*0.4);
            grad.addColorStop(0, '#FFDAB9'); // Peach Puff
            grad.addColorStop(1, '#FAEBD7'); // Antique White
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
            break;
        }
        case 'love_minimal_line': {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);
            ctx.strokeStyle = '#FF69B4'; // Hot Pink
            ctx.lineWidth = W / 50;
            // Simple inner border
            ctx.strokeRect(W/20, H/20, W * 0.9, H * 0.9);
            break;
        }
        case 'love_polaroid_tape': {
            ctx.fillStyle = '#F5F5DC'; // Beige (Cream)
            ctx.fillRect(0, 0, W, H);
            // Simple tape simulation (two strips)
            ctx.fillStyle = 'rgba(200, 200, 200, 0.4)';
            const tapeHeight = H * 0.05;
            ctx.fillRect(W/4 - 10, H*0.1, W/2, tapeHeight);
            ctx.fillRect(W/4 + 10, H*0.9 - tapeHeight, W/2, tapeHeight);
            break;
        }

        // --- Máº·c Ä‘á»‹nh (Tráº¯ng Tá»‘i Giáº£n) ---
        case 'default':
        default:
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, W, H);
            break;
    }
    
    ctx.restore();
}

// Merge Strip Logic
async function mergeStrip(images) {
    if (images.length !== 4) return;
    
    const photoW = BASE_FRAME_H; 
    const photoH = BASE_FRAME_H; 
    const innerBorderColor = '#F0F0F0';
    
    const layout = layoutSelect.value;
    const backgroundId = backgroundSelect.value;
    const overlayId = overlaySelect.value;
    const customText = customStripText.value.toUpperCase();

    // Láº¥y cÃ¡c tham sá»‘ kÃ­ch thÆ°á»›c dá»±a trÃªn layout
    const stripMarginX = VERT_MARGIN_X;
    const vertTextH = VERT_TEXT_H;
    const vertMarginY = VERT_MARGIN_Y;
    const gridOuterPadding = GRID_OUTER_PADDING;
    const gridGap = GRID_GAP;
    const gridTextH = GRID_TEXT_H;

    let W, H;
    let textStripYStart, textStripTotalHeight;
    const numPhotos = images.length;
    
    // 1. TÃ­nh toÃ¡n kÃ­ch thÆ°á»›c canvas cuá»‘i cÃ¹ng (W, H)
    if (layout === 'vertical') {
        const numPrevGaps = numPhotos - 1;
        W = photoW + stripMarginX * 2; 
        H = numPhotos * photoH + numPrevGaps * VERT_GAP + vertTextH + vertMarginY * 2; 
        textStripYStart = vertMarginY + numPhotos * photoH + numPrevGaps * VERT_GAP;
        textStripTotalHeight = vertTextH + vertMarginY; 
        stripSizeText.textContent = `${W} x ${H} pixels (Fixed 1:1 Photo)`;
    } else { // Grid (2x2) - BORDERLESS
        W = 2 * photoW + gridGap + 2 * gridOuterPadding; 
        H = 2 * photoH + gridGap + 2 * gridOuterPadding + gridTextH; 
        textStripYStart = 2 * photoH + gridGap + 2 * gridOuterPadding; 
        textStripTotalHeight = gridTextH; 
        stripSizeText.textContent = `${W} x ${H} pixels (Fixed 1:1 Photo)`;
    }
    
    const canvas = document.createElement('canvas');
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext('2d');
    
    // 2. Váº½ Background
    drawComplexBackground(ctx, W, H, backgroundId, layout, textStripYStart, textStripTotalHeight);
    
    // 3. Váº½ 4 áº£nh
    const loadedImages = await Promise.all(images.map(loadImg));
    
    for (let i = 0; i < numPhotos; i++) {
        const img = loadedImages[i];
        let finalImageX, finalImageY;
        
        if (layout === 'vertical') {
            const numPrevGaps = i;
            finalImageX = stripMarginX;
            finalImageY = vertMarginY + i * photoH + numPrevGaps * VERT_GAP; 
        } else { // Grid (2x2)
            const col = i % 2;
            const row = Math.floor(i / 2);
            finalImageX = gridOuterPadding + col * (photoW + gridGap);
            finalImageY = gridOuterPadding + row * (photoH + gridGap);
        }
        
        // DRAW Photo (Border-less)
        ctx.fillStyle = innerBorderColor;
        ctx.fillRect(finalImageX - INNER_BORDER, finalImageY - INNER_BORDER, photoW + 2*INNER_BORDER, photoH + 2*INNER_BORDER);
        
        // [Cáº¬P NHáº¬T LOGIC] Váº½ viá»n 4px bao quanh áº£nh (TÄƒng Ä‘á»™ ná»•i báº­t)
        ctx.strokeStyle = FINAL_PHOTO_BORDER_COLOR;
        ctx.lineWidth = FINAL_PHOTO_BORDER_WIDTH;
        ctx.strokeRect(finalImageX, finalImageY, photoW, photoH);
        
        ctx.drawImage(img, finalImageX, finalImageY, photoW, photoH);
        
        // 3. Ãp dá»¥ng Overlay/Filter cho tá»«ng áº£nh
        drawOverlayFrame_ORIGINAL(ctx, finalImageX, finalImageY, photoW, photoH, overlayId);
    }
    
    // 4. Váº½ Header/Footer Text Strip
    // Äiá»u chá»‰nh mÃ u chá»¯ cho cÃ¡c theme ná»n Ä‘áº­m
    if (['tet_red_gold_silk', 'tet_firecracker_pattern', 'tet_lucky_money', 'tet_lantern_glow', 'tet_calligraphy_paper', 'xmas_pine_forest_green', 'xmas_snowy_bokeh', 'xmas_gold_glitter', 'xmas_gingerbread', 'xmas_santa_suit', 'love_rose_petals', 'love_velvet_magenta', 'love_couple_galaxy'].includes(backgroundId)) {
        ctx.fillStyle = '#FFFFFF';
    } else {
        ctx.fillStyle = '#333333';
    }

    ctx.save();
    ctx.textAlign = 'center';

    // Váº½ text chÃ­nh
    ctx.font = `bold ${layout === 'vertical' ? 50 : 60}px Nunito, sans-serif`;
    let textY = textStripYStart + (layout === 'vertical' ? vertTextH : gridTextH) / 2;
    textY -= (layout === 'vertical' ? 20 : 30); 
    
    let finalFontSize = layout === 'vertical' ? 50 : 60;
    if (customText.length > 20) {
        finalFontSize = layout === 'vertical' ? 30 : 40;
    } else if (customText.length > 15) {
        finalFontSize = layout === 'vertical' ? 40 : 50;
    }
    ctx.font = `bold ${finalFontSize}px Nunito, sans-serif`;

    ctx.fillText(customText, W / 2, textY);

    // Váº½ Sub-text (Date/Time)
    ctx.font = `italic ${layout === 'vertical' ? 18 : 22}px Varela Round, sans-serif`;
    // Set mÃ u chá»¯ má»
    ctx.fillStyle = (['tet_red_gold_silk', 'tet_firecracker_pattern', 'tet_lucky_money', 'tet_lantern_glow', 'tet_calligraphy_paper', 'xmas_pine_forest_green', 'xmas_snowy_bokeh', 'xmas_gold_glitter', 'xmas_gingerbread', 'xmas_santa_suit', 'love_rose_petals', 'love_velvet_magenta', 'love_couple_galaxy'].includes(backgroundId)
        ? 'rgba(255,255,255,0.7)' : 'rgba(60,70,90,0.7)');

    ctx.textAlign = 'center';
    const dateText = getFormattedNow();
    let dateY = textStripYStart + (layout === 'vertical' ? vertTextH : gridTextH) / 2 + (layout === 'vertical' ? 15 : 20); 
    
    ctx.fillText(dateText, W / 2, dateY);
    
    ctx.restore();
    
    return { dataUrl: canvas.toDataURL('image/png'), W: W, H: H };
}


function mergeAndShowFinal() {
    mergeStrip(captures).then(result => {
        showFinal(result);
    }).catch(e => {
        console.error('Lá»—i khi ghÃ©p áº£nh:', e);
        finalPreview.innerHTML = '<div class="small" style="color:red">Lá»—i khi ghÃ©p áº£nh. Xem console.</div>';
    });
}

function addThumbnail(imgDataUrl, index){
    const wrapper = document.createElement('div');
    wrapper.className = 'instax-thumb-frame';
    wrapper.dataset.index = index;
    wrapper.style.aspectRatio = getInstaxFilmRatio('square') + ' / 1';
    const img = document.createElement('img');
    img.src = imgDataUrl;
    img.alt = `Pose ${index}`;
    wrapper.appendChild(img);
    wrapper.onclick = () => {
        triggerDownload(imgDataUrl, `photobooth_pose_${index}_${dateForFilename()}.png`);
    };
    previewGrid.appendChild(wrapper);
}

function showFinal(result){
    finalPreview.innerHTML = '';
    finalImageDataUrl = result.dataUrl;
    finalActionsEl.style.display = 'flex';
    // Ãp dá»¥ng tá»· lá»‡ Ä‘á»™ng Ä‘Ã£ tÃ­nh toÃ¡n
    finalPreview.style.aspectRatio = `${result.W} / ${result.H}`;
    const img = document.createElement('img');
    img.src = result.dataUrl;
    finalPreview.appendChild(img);
    finalPreview.style.width = 'auto';
    finalPreview.style.height = 'auto';
}

function resetAll(){
    captures = [];
    previewGrid.innerHTML = '';
    finalPreview.innerHTML = '<div class="small">ChÆ°a cÃ³ áº£nh</div>';
    finalImageDataUrl = null;
    finalActionsEl.style.display = 'none';
    finalPreview.style.width = 'auto';
    finalPreview.style.height = 'auto';
    enableControls();
}

function triggerDownload(dataUrl, filename) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function dateForFilename(){
    const now = new Date();
    const Y = now.getFullYear();
    const M = String(now.getMonth() + 1).padStart(2, '0');
    const D = String(now.getDate()).padStart(2, '0');
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    return `${Y}${M}${D}_${h}${m}${s}`;
}


// Khá»Ÿi táº¡o
window.onload = () => {
    document.getElementById('startPhotoboothBtn').addEventListener('click', () => {
        showCaptureScreen();
        startCamera();
    });
    
    document.getElementById('startBtn').addEventListener('click', startPhotobooth);
    document.getElementById('redoBtn').addEventListener('click', resetAll);
    document.getElementById('downloadFinalBtn').addEventListener('click', () => {
        if (finalImageDataUrl) {
            triggerDownload(finalImageDataUrl, `photobooth_strip_${dateForFilename()}.png`);
        }
    });
    document.getElementById('stopCamBtn').addEventListener('click', stopCamera);
    document.getElementById('switchCamBtn').addEventListener('click', switchCamera);
    document.getElementById('refreshBtn').addEventListener('click', () => window.location.reload());
    document.getElementById('backToCaptureBtn').addEventListener('click', backToWelcome);

    // Tá»± Ä‘á»™ng merge láº¡i khi thay Ä‘á»•i tÃ¹y chá»n
    backgroundSelect.addEventListener('change', () => {
        if (captures.length === 4) mergeAndShowFinal();
    });
    overlaySelect.addEventListener('change', () => {
        if (captures.length === 4) mergeAndShowFinal();
    });
    // NEW: ThÃªm sá»± kiá»‡n cho beautyLevel
    beautyLevel.addEventListener('change', () => { 
        if (captures.length > 0) {
            // VÃ¬ beauty filter Ã¡p dá»¥ng khi chá»¥p, cáº§n reset Ä‘á»ƒ chá»¥p láº¡i
            alert('LÃ m má»‹n da lÃ  hiá»‡u á»©ng Ä‘Æ°á»£c Ã¡p dá»¥ng ngay khi chá»¥p. Vui lÃ²ng báº¥m "Reset áº¢nh Chá»¥p" vÃ  chá»¥p láº¡i Ä‘á»ƒ Ã¡p dá»¥ng cáº¥p Ä‘á»™ má»›i.');
            // Váº«n cho phÃ©p ngÆ°á»i dÃ¹ng thay Ä‘á»•i nhÆ°ng thÃ´ng bÃ¡o cáº§n chá»¥p láº¡i
        }
    });
    // END NEW
    layoutSelect.addEventListener('change', () => {
        if (captures.length === 4) mergeAndShowFinal();
    });
    customStripText.addEventListener('input', () => {
        if (captures.length === 4) mergeAndShowFinal();
    });

    window.addEventListener('resize', resizeOverlay);
};
</script>